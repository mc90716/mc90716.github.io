<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="云袭" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="Pigeon开发指南Pigeon是一个分布式服务通信框架（RPC），在美团点评内部广泛使用，是美团点评最基础的底层框架之一。 主要特色除了支持spring schema等配置方式，也支持代码annotation方式发布服务、引用远程服务，并提供原生api接口的用法。">
<meta property="og:type" content="article">
<meta property="og:title" content="pigeon">
<meta property="og:url" content="http://yoursite.com/2018/01/20/pigeon/index.html">
<meta property="og:site_name" content="云袭">
<meta property="og:description" content="Pigeon开发指南Pigeon是一个分布式服务通信框架（RPC），在美团点评内部广泛使用，是美团点评最基础的底层框架之一。 主要特色除了支持spring schema等配置方式，也支持代码annotation方式发布服务、引用远程服务，并提供原生api接口的用法。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-01-20T09:08:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="pigeon">
<meta name="twitter:description" content="Pigeon开发指南Pigeon是一个分布式服务通信框架（RPC），在美团点评内部广泛使用，是美团点评最基础的底层框架之一。 主要特色除了支持spring schema等配置方式，也支持代码annotation方式发布服务、引用远程服务，并提供原生api接口的用法。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/01/20/pigeon/"/>





  <title>pigeon | 云袭</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

	<a href="https://github.com/myunxi"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/8b6b8ccc6da3aa5722903da7b58eb5ab1081adee/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_orange_ff7600.png"></a>

	
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">云袭</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/20/pigeon/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="马超">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云袭">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">pigeon</h1>
        

        <div class="post-meta">
		
		 <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-20T17:05:57+08:00">
                2018-01-20
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/20/pigeon/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/20/pigeon/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Pigeon开发指南"><a href="#Pigeon开发指南" class="headerlink" title="Pigeon开发指南"></a>Pigeon开发指南</h1><p>Pigeon是一个分布式服务通信框架（RPC），在美团点评内部广泛使用，是美团点评最基础的底层框架之一。</p>
<h2 id="主要特色"><a href="#主要特色" class="headerlink" title="主要特色"></a>主要特色</h2><p>除了支持spring schema等配置方式，也支持代码annotation方式发布服务、引用远程服务，并提供原生api接口的用法。</p>
<a id="more"></a>
<p>支持http协议，方便非java应用调用pigeon的服务。</p>
<p>序列化方式除了hessian，还支持thrift等。</p>
<p>提供了服务器单机控制台pigeon-console，包含单机服务测试工具。</p>
<p>创新的客户端路由策略，提供服务预热功能，解决线上流量大的service重启时大量超时的问题。</p>
<p>记录每个请求的对象大小、返回对象大小等监控信息。</p>
<p>服务端可对方法设置单独的线程池进行服务隔离，可配置客户端应用的最大并发数进行限流。</p>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><p>Pigeon依赖JDK1.7+</p>
<p>pom依赖定义：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dianping<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pigeon<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;pigeon.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>pom里加入以下仓库依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>github-dianping-maven-repo<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://raw.githubusercontent.com/dianping/maven-repo/master<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>always<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>pigeon在运行时可能会依赖以下jar包，如果有必要，需要应用自行加上以下jar(版本建议高于或等于以下基础版本)：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 监控框架依赖，下面的cat依赖是可选的，如果不依赖cat则默认不会有监控功能，如果想接入美团点评的监控框架cat（已经开源），需增加以下依赖（pigeon-monitor-cat代码在https://github.com/wu-xiang/pigeon-monitor-cat） --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dianping<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pigeon-monitor-cat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dianping.cat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cat-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.6-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置框架依赖，下面的lion依赖是可选的，如果不依赖lion则会默认通过本地文件加载配置，如果想接入美团点评的配置框架lion(尚未开源)，需增加以下依赖（pigeon-config-lion代码在https://github.com/wu-xiang/pigeon-config-lion） --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dianping<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pigeon-config-lion<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dianping.lion<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lion-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 加入spring，版本根据自身需要设置，spring.version可以是大多数spring版本如3.2.9.RELEASE --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 如果是非tomcat项目需要自行加入servlet-api的jar，servlet.version可以是2.5-20081211 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mortbay.jetty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;servlet.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 需要自行加入swift的jar，swift.version可以是0.17.0或更高版本 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.facebook.swift<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swift-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;swift.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.facebook.swift<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swift-codec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;swift.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.facebook.swift<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swift-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;swift.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>如果是在外部公司使用开源版本pigeon，需要关注此章节，进行一些准备工作：</p>
<h3 id="通过maven构建项目"><a href="#通过maven构建项目" class="headerlink" title="通过maven构建项目"></a>通过maven构建项目</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/dianping/pigeon.git pigeon-parent</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> pigeon-parent</span><br><span class="line"></span><br><span class="line">mvn clean install -DskipTests</span><br></pre></td></tr></table></figure>
<h3 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h3><h4 id="ZooKeeper安装"><a href="#ZooKeeper安装" class="headerlink" title="ZooKeeper安装"></a>ZooKeeper安装</h4><p>pigeon内部使用zookeeper作为注册中心，需要安装好zookeeper集群。</p>
<h4 id="配置ZooKeeper集群地址"><a href="#配置ZooKeeper集群地址" class="headerlink" title="配置ZooKeeper集群地址"></a>配置ZooKeeper集群地址</h4><p>如未使用美团点评配置框架Lion，需在应用代码resources/config/pigeon.properties里（也可以在绝对路径/data/webapps/config/pigeon.properties里）设置注册中心zookeeper地址：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pigeon.registry.address=10.1.1.1:2181,10.1.1.2:2181,10.1.1.3:2181,10.1.1.4:2181,10.1.1.5:2181</span><br></pre></td></tr></table></figure></p>
<h3 id="配置服务摘除脚本"><a href="#配置服务摘除脚本" class="headerlink" title="配置服务摘除脚本"></a>配置服务摘除脚本</h3><p>由于pigeon内部是在zookeeper里使用持久化节点，如果非正常关闭JVM，不会从ZooKeeper集群里摘除相应的本机服务的ip、port，需要在关闭JVM脚本里（比如tomcat的shutdown.sh脚本）加入以下调用：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/curl -s --connect-timeout 5  --speed-time 6 --speed-limit 1 <span class="string">"http://127.0.0.1:4080/services.unpublish"</span></span><br></pre></td></tr></table></figure></p>
<p>该脚本内部会等待3秒，如果成功会返回ok，等该脚本执行成功再关闭JVM</p>
<h3 id="配置应用名称"><a href="#配置应用名称" class="headerlink" title="配置应用名称"></a>配置应用名称</h3><p>在应用代码resources/META-INF/app.properties文件里设置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.name=xxx</span><br></pre></td></tr></table></figure></p>
<p>代表此应用名称为xxx，定义应用名称是基于规范应用的考虑</p>
<h2 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h2><p>pigeon内部有一系列配置，用于不同应用进行定制，应用级的配置是独立的config模块来支撑，配置的管理可以有以下3个选择：</p>
<h3 id="本地配置"><a href="#本地配置" class="headerlink" title="本地配置"></a>本地配置</h3><p>本地配置是在机器级别配置properties文件里存储，开源版本如果没有依赖其他扩展的配置中心，默认会用本地配置。</p>
<p>本地配置是在应用的classpath下放config/pigeon.properties文件（该文件的配置是所有环境都生效，包括关闭线上自动注册，请谨慎使用）</p>
<p>如果是只设置某个环境的配置，如开发环境可以用pigeon_dev.properties，测试环境可以用pigeon_qa.properties，环境定义如dev、qa可自行定义</p>
<p>如果是全局配置，这个配置文件也可以放在绝对路径/data/webapps/config/pigeon/pigeon.properties文件里</p>
<p>例如pigeon内部有一个全局默认配置pigeon.provider.applimit.enable，值为false，如果某个应用想修改这个默认配置，可以在properties文件里增加一行：</p>
<p>pigeon.provider.applimit.enable=true</p>
<h3 id="lion配置"><a href="#lion配置" class="headerlink" title="lion配置"></a>lion配置</h3><p>如果使用了点评内部的lion配置中心，相比本地配置管理上更加方便，在lion管理端进行配置的统一管理，无需在每台机器上的properties文件里进行配置</p>
<p>lion配置需要按前面依赖里提到的引入以下依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dianping<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pigeon-config-lion<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>如果要设置某个应用级的pigeon配置，需要在lion里增加相应的pigeon配置，如pigeon内部有一个全局默认配置pigeon.provider.applimit.enable，值为false</p>
<p>如果某个应用xxx-service（这个应用名就是app.properties里的app.name）想修改这个默认配置，那么可以在lion里增加一个key：xxx-service.pigeon.provider.applimit.enable，设置为true</p>
<p>本文档里提到的所有配置，如果要在应用级修改配置，都需要按这个规则在lion进行配置。</p>
<p>应用级的配置优先级高于pigeon内部的默认配置，比如xxx-service.pigeon.provider.applimit.enable的优先级高于pigeon.provider.applimit.enable</p>
<h3 id="扩展pigeon-config模块"><a href="#扩展pigeon-config模块" class="headerlink" title="扩展pigeon-config模块"></a>扩展pigeon-config模块</h3><p>如果外部公司想集成自己公司内部的配置中心，可以扩展pigeon的pigeon-config模块，需要继承AbstractConfigManager：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XXXConfigManager</span> <span class="keyword">extends</span> <span class="title">AbstractConfigManager</span></span></span><br></pre></td></tr></table></figure></p>
<p>然后在自己的classpath下放META-INF/services/com.dianping.pigeon.config.ConfigManager文件，文件内容是扩展类的类名：</p>
<p>com.xxx….XXXConfigManager</p>
<p>完成以上步骤后，需要将这个扩展项目打成jar包，引入项目里，pigeon就会自动使用用户自己扩展的配置模块</p>
<h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><p>本文档相关代码示例也可以参考<a href="https://github.com/dianping/pigeon-demo" target="_blank" rel="noopener">pigeon-demo</a>项目</p>
<h3 id="定义服务"><a href="#定义服务" class="headerlink" title="定义服务"></a>定义服务</h3><p>定义服务接口: (该接口需单独打包，在服务提供方和调用方共享)</p>
<blockquote>
<p>EchoService.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dianping.pigeon.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EchoService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">(String name)</span></span>;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在服务提供方实现接口：(对服务调用方隐藏实现)</p>
<blockquote>
<p>EchoServiceImpl.java</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package com.dianping.pigeon.demo.provider;</span><br><span class="line"></span><br><span class="line">import com.dianping.pigeon.demo.EchoService;</span><br><span class="line"></span><br><span class="line">public class EchoServiceImpl implements EchoService &#123;</span><br><span class="line"></span><br><span class="line">	public String echo(String name) &#123;</span><br><span class="line">		return &quot;Hello &quot; + name;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="服务提供者"><a href="#服务提供者" class="headerlink" title="服务提供者"></a>服务提供者</h3><p>这里先介绍传统spring方式，后边章节会介绍annotation方式、spring schema定义方式、api方式。</p>
<p>Spring配置声明暴露服务：</p>
<blockquote>
<p>provider.xml</p>
</blockquote>
<p>services属性下的key是服务全局唯一的标识url（如果一个远程服务未特别设置，url默认是服务接口类名），value是引用的服务bean<br>port属性可不指定<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.dianping.pigeon.remoting.provider.config.spring.ServiceBean"</span> <span class="attr">init-method</span>=<span class="string">"init"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"services"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"http://service.dianping.com/demoService/echoService_1.0.0"</span> <span class="attr">value-ref</span>=<span class="string">"echoServiceImpl"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"port"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>5008<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"echoServiceImpl"</span> <span class="attr">class</span>=<span class="string">"com.dianping.pigeon.demo.provider.EchoServiceImpl"</span> /&gt;</span></span><br><span class="line">```	</span><br><span class="line">加载Spring配置：</span><br><span class="line"></span><br><span class="line">&gt; Provider.java</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">import org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line">public class Provider &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">    	ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(new String[] &#123;"provider.xml"&#125;);</span><br><span class="line">    	context.start();</span><br><span class="line">    	System.in.read(); // 按任意键退出</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="服务调用者"><a href="#服务调用者" class="headerlink" title="服务调用者"></a>服务调用者</h3><p>这里先介绍传统spring方式，后边章节会介绍annotation方式、spring schema定义方式、api方式。</p>
<p>通过Spring配置引用远程服务：</p>
<blockquote>
<p>invoker.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"echoService"</span> <span class="attr">class</span>=<span class="string">"com.dianping.pigeon.remoting.invoker.config.spring.ReferenceBean"</span> <span class="attr">init-method</span>=<span class="string">"init"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 服务全局唯一的标识url，默认是服务接口类名，必须设置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"http://service.dianping.com/demoService/echoService_1.0.0"</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 接口名称，必须设置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"interfaceName"</span> <span class="attr">value</span>=<span class="string">"com.dianping.pigeon.demo.EchoService"</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 超时时间，毫秒，默认5000，建议自己设置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeout"</span> <span class="attr">value</span>=<span class="string">"2000"</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 序列化，hessian/fst/protostuff，默认hessian，可不设置--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serialize"</span> <span class="attr">value</span>=<span class="string">"hessian"</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 调用方式，sync/future/callback/oneway，默认sync，可不设置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"callType"</span> <span class="attr">value</span>=<span class="string">"sync"</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 失败策略，快速失败failfast/失败转移failover/失败忽略failsafe/并发取最快返回forking，默认failfast，可不设置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cluster"</span> <span class="attr">value</span>=<span class="string">"failfast"</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 是否超时重试，默认false，可不设置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeoutRetry"</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 重试次数，默认1，可不设置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"retries"</span> <span class="attr">value</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">```		</span><br><span class="line">加载Spring配置，并调用远程服务：</span><br><span class="line"></span><br><span class="line">&gt; Invoker.java</span><br></pre></td></tr></table></figure>
<p>import org.springframework.context.support.ClassPathXmlApplicationContext;<br>import com.dianping.pigeon.demo.EchoService;</p>
<p>public class Invoker {</p>
<pre><code>public static void main(String[] args) throws Exception {
    ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(new String[] {“invoker.xml&quot;});
    context.start();
    EchoService echoService = (EchoService)context.getBean(“echoService&quot;); // 获取远程服务代理
    String hello = echoService.echo(&quot;world&quot;);
    System.out.println( hello );
}
</code></pre><p>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## Annotation编程方式</span><br><span class="line"></span><br><span class="line">Annotation方式的编程无需在Spring里定义每个bean，但仍需依赖spring，具体使用方式如下：</span><br><span class="line"></span><br><span class="line">### 服务提供者</span><br><span class="line">EchoService是一个远程服务的接口：</span><br><span class="line">```java</span><br><span class="line">public interface EchoService &#123;</span><br><span class="line"></span><br><span class="line">	String echo(String input);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在服务端需要实现这个服务接口，服务实现类上需要加上@Service（com.dianping.pigeon.remoting.provider.config.annotation.Service）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoServiceAnnotationImpl</span> <span class="keyword">implements</span> <span class="title">EchoService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">return</span> <span class="string">"annotation service echo:"</span> + input;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>除此之外，只需要在spring配置里加上pigeon:annotation配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> </span></span><br><span class="line"><span class="tag">		<span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span> </span></span><br><span class="line"><span class="tag">		<span class="attr">xmlns:pigeon</span>=<span class="string">"http://code.dianping.com/schema/pigeon"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd </span></span></span><br><span class="line"><span class="tag"><span class="string">		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd </span></span></span><br><span class="line"><span class="tag"><span class="string">		http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd </span></span></span><br><span class="line"><span class="tag"><span class="string">		http://code.dianping.com/schema/pigeon http://code.dianping.com/schema/pigeon/pigeon-service-2.0.xsd"</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">&lt;!-- 默认只扫描com.dianping包，如果非此包下的服务需要自定义package属性，多个package以逗号,分隔--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pigeon:annotation</span> /&gt;</span></span><br><span class="line">		</span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>@Service在pigeon内部的定义如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Service &#123;</span><br><span class="line"></span><br><span class="line">	Class&lt;?&gt; interfaceClass() <span class="keyword">default</span> <span class="keyword">void</span>.class;</span><br><span class="line">	<span class="function">String <span class="title">url</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">	<span class="function">String <span class="title">version</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">	<span class="function">String <span class="title">group</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">port</span><span class="params">()</span> <span class="keyword">default</span> 4040</span>;</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">autoSelectPort</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">useSharedPool</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">actives</span><span class="params">()</span> <span class="keyword">default</span> 0</span>;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="服务调用者-1"><a href="#服务调用者-1" class="headerlink" title="服务调用者"></a>服务调用者</h3><p>假设在客户端有一个AnnotationTestService，需要引用远程的EchoService服务，只需要在field或method上加上@Reference：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationTestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Reference</span>(timeout = <span class="number">1000</span>)</span><br><span class="line">    <span class="keyword">private</span> EchoService echoService;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testEcho</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">return</span> echoService.echo(input);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">```		</span><br><span class="line">只需要在spring配置里加上pigeon:annotation配置：</span><br><span class="line">```xml</span><br><span class="line">&lt;beans xmlns=<span class="string">"http://www.springframework.org/schema/beans"</span></span><br><span class="line">		xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> </span><br><span class="line">		xmlns:context=<span class="string">"http://www.springframework.org/schema/context"</span></span><br><span class="line">		xmlns:tx=<span class="string">"http://www.springframework.org/schema/tx"</span> </span><br><span class="line">		xmlns:pigeon=<span class="string">"http://code.dianping.com/schema/pigeon"</span></span><br><span class="line">		xsi:schemaLocation=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd </span></span><br><span class="line"><span class="string">		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd </span></span><br><span class="line"><span class="string">		http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd </span></span><br><span class="line"><span class="string">		http://code.dianping.com/schema/pigeon http://code.dianping.com/schema/pigeon/pigeon-service-2.0.xsd"</span>&gt;</span><br><span class="line"></span><br><span class="line">	&lt;!-- 默认只扫描com.dianping包，如果非此包下的服务需要自定义<span class="keyword">package</span>属性，多个<span class="keyword">package</span>以逗号,分隔--&gt;</span><br><span class="line">	&lt;pigeon:annotation /&gt;</span><br><span class="line">	</span><br><span class="line">	&lt;bean id=<span class="string">"annotationTestService"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"com.dianping.pigeon.demo.invoker.annotation.AnnotationTestService"</span> /&gt;</span><br><span class="line">	</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></p>
<p>@Reference定义：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Reference &#123;</span><br><span class="line"></span><br><span class="line">	Class&lt;?&gt; interfaceClass() <span class="keyword">default</span> <span class="keyword">void</span>.class;</span><br><span class="line">	<span class="function">String <span class="title">url</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">	<span class="function">String <span class="title">protocol</span><span class="params">()</span> <span class="keyword">default</span> "<span class="keyword">default</span>"</span>;</span><br><span class="line">	<span class="function">String <span class="title">serialize</span><span class="params">()</span> <span class="keyword">default</span> "hessian"</span>;</span><br><span class="line">	<span class="function">String <span class="title">callType</span><span class="params">()</span> <span class="keyword">default</span> "sync"</span>;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">timeout</span><span class="params">()</span> <span class="keyword">default</span> 5000</span>;</span><br><span class="line">	<span class="function">String <span class="title">callback</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">	<span class="function">String <span class="title">loadbalance</span><span class="params">()</span> <span class="keyword">default</span> "weightedAutoaware"</span>;</span><br><span class="line">	<span class="function">String <span class="title">cluster</span><span class="params">()</span> <span class="keyword">default</span> "failfast"</span>;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">retries</span><span class="params">()</span> <span class="keyword">default</span> 1</span>;</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">timeoutRetry</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">	<span class="function">String <span class="title">version</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">	<span class="function">String <span class="title">group</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Spring-Schema配置方式"><a href="#Spring-Schema配置方式" class="headerlink" title="Spring Schema配置方式"></a>Spring Schema配置方式</h2><h3 id="服务端Spring配置"><a href="#服务端Spring配置" class="headerlink" title="服务端Spring配置"></a>服务端Spring配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:pigeon</span>=<span class="string">"http://code.dianping.com/schema/pigeon"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/beans/spring-beans-2.5.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://code.dianping.com/schema/pigeon http://code.dianping.com/schema/pigeon/pigeon-service-2.0.xsd"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">default-autowire</span>=<span class="string">"byName"</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"echoServiceImpl"</span> <span class="attr">class</span>=<span class="string">"com.dianping.pigeon.demo.provider.EchoServiceImpl"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pigeon:service</span> <span class="attr">id</span>=<span class="string">"echoService"</span> <span class="attr">interface</span>=<span class="string">"com.dianping.pigeon.demo.EchoService"</span> <span class="attr">ref</span>=<span class="string">"echoServiceImpl"</span> /&gt;</span></span><br><span class="line">      </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>也可以指定服务url（代表这个服务的唯一性标识，默认是接口类名）和port等属性：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"echoServiceImpl"</span> <span class="attr">class</span>=<span class="string">"com.dianping.pigeon.demo.provider.EchoServiceImpl"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">pigeon:service</span> <span class="attr">id</span>=<span class="string">"echoService"</span> <span class="attr">url</span>=<span class="string">"http://service.dianping.com/demoService/echoService_1.0.0"</span> <span class="attr">interface</span>=<span class="string">"com.dianping.pigeon.demo.EchoService"</span> <span class="attr">port</span>=<span class="string">"4040"</span> <span class="attr">ref</span>=<span class="string">"echoServiceImpl"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="客户端Spring配置"><a href="#客户端Spring配置" class="headerlink" title="客户端Spring配置"></a>客户端Spring配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:pigeon</span>=<span class="string">"http://code.dianping.com/schema/pigeon"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://code.dianping.com/schema/pigeon http://code.dianping.com/schema/pigeon/pigeon-service-2.0.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">pigeon:reference</span> <span class="attr">id</span>=<span class="string">"echoService"</span> <span class="attr">timeout</span>=<span class="string">"1000"</span> <span class="attr">protocol</span>=<span class="string">"http"</span> <span class="attr">serialize</span>=<span class="string">"hessian"</span> <span class="attr">callType</span>=<span class="string">"sync"</span> <span class="attr">interface</span>=<span class="string">"com.dianping.pigeon.demo.EchoService"</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- timeout-超时时间，毫秒--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- callType-调用方式，sync/future/callback/oneway，默认sync --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- protocol-协议，default/http，默认default --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- serialize-序列化，hessian/thrift/fst/protostuff，默认hessian --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- cluser调用失败策略，快速失败failfast/失败转移failover/失败忽略failsafe/并发取最快返回forking，默认failfast  --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- timeoutRetry是否超时重试，在cluster为failover时有效，默认false  --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- retries超时重试次数，在cluster为failover时有效  --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- interface-服务接口名称 --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- url-服务全局唯一的标识url --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- callback-服务回调对象 --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- loadBalance-负载均衡类型，autoaware/roundRobin/random，默认autoaware --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"echoServiceCallback"</span> <span class="attr">class</span>=<span class="string">"com.dianping.pigeon.demo.invoker.EchoServiceCallback"</span> /&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">pigeon:reference</span> <span class="attr">id</span>=<span class="string">"echoServiceWithCallback"</span> <span class="attr">timeout</span>=<span class="string">"1000"</span> <span class="attr">protocol</span>=<span class="string">"http"</span> <span class="attr">serialize</span>=<span class="string">"hessian"</span> <span class="attr">callType</span>=<span class="string">"sync"</span> <span class="attr">interface</span>=<span class="string">"com.dianping.pigeon.demo.EchoService"</span> <span class="attr">callback</span>=<span class="string">"echoServiceCallback"</span> /&gt;</span></span><br><span class="line">	</span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>也可以指定服务url（代表这个服务的唯一性标识，默认是接口类名）属性：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">pigeon:reference</span> <span class="attr">id</span>=<span class="string">"echoService"</span> <span class="attr">url</span>=<span class="string">"http://service.dianping.com/demoService/echoService_1.0.0"</span>  <span class="attr">timeout</span>=<span class="string">”1000”</span> <span class="attr">interface</span>=<span class="string">"com.dianping.pigeon.demo.EchoService"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"echoServiceCallback"</span> <span class="attr">class</span>=<span class="string">"com.dianping.pigeon.demo.invoker.EchoServiceCallback"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">pigeon:reference</span> <span class="attr">id</span>=<span class="string">"echoServiceWithCallback"</span> <span class="attr">url</span>=<span class="string">"http://service.dianping.com/demoService/echoService_1.0.0"</span> <span class="attr">timeout</span>=<span class="string">”1000”</span> <span class="attr">interface</span>=<span class="string">"com.dianping.pigeon.demo.EchoService"</span> <span class="attr">callType</span>=<span class="string">"callback"</span> <span class="attr">callback</span>=<span class="string">"echoServiceCallback"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="API编程方式"><a href="#API编程方式" class="headerlink" title="API编程方式"></a>API编程方式</h2><h3 id="服务提供者-1"><a href="#服务提供者-1" class="headerlink" title="服务提供者"></a>服务提供者</h3><blockquote>
<p>Provider.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Provider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    	ServiceFactory.addService(EchoService.class, <span class="keyword">new</span> EchoServiceImpl());</span><br><span class="line">    	System.in.read(); <span class="comment">// 按任意键退出</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如需自定义服务url（代表这个服务的唯一性标识，默认是接口类名）或端口等参数，可以参考以下代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ServiceFactory.publishService(<span class="string">"http://service.dianping.com/demoService/echoService_1.0.0"</span>, EchoService.class, <span class="keyword">new</span> EchoServiceImpl(), <span class="number">4040</span>);</span><br></pre></td></tr></table></figure></p>
<p>更详细的API接口可以参考ServiceFactory类的api详细说明。</p>
<h3 id="服务调用者-2"><a href="#服务调用者-2" class="headerlink" title="服务调用者"></a>服务调用者</h3><blockquote>
<p>Invoker.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Invoker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		EchoService echoService = ServiceFactory.getService(EchoService.class); <span class="comment">// 获取远程服务代理</span></span><br><span class="line">		String hello = echoService.echo(<span class="string">"world"</span>);</span><br><span class="line">		System.out.println( hello );</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line">```		</span><br><span class="line">如果要调用的服务定义了特定的url（代表这个服务的唯一性标识，默认是接口类名），需要客户端指定服务url，可以参考如下代码：</span><br><span class="line">```java</span><br><span class="line">EchoService echoService = ServiceFactory.getService(<span class="string">"http://service.dianping.com/demoService/echoService_1.0.0"</span>, EchoService.class, <span class="number">2000</span>); <span class="comment">// 获取远程服务代理</span></span><br><span class="line">String hello = echoService.echo(<span class="string">"world"</span>);</span><br><span class="line">System.out.println( hello );</span><br></pre></td></tr></table></figure>
<p>如果要程序指定序列化方式或协议类型，可以参考如下代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">InvokerConfig&lt;EchoService&gt; config = <span class="keyword">new</span> InvokerConfig&lt;EchoService&gt;(EchoService.class);</span><br><span class="line">config.setProtocol(InvokerConfig.PROTOCOL_DEFAULT);</span><br><span class="line">config.setSerialize(InvokerConfig.SERIALIZE_HESSIAN);</span><br><span class="line">EchoService service = ServiceFactory.getService(config);</span><br><span class="line">String hello = service.echo(<span class="string">"world"</span>);</span><br><span class="line">System.out.println( hello );</span><br></pre></td></tr></table></figure></p>
<p>更详细的api接口可以参考ServiceFactory类的api详细说明。</p>
<h3 id="ServiceFactory接口"><a href="#ServiceFactory接口" class="headerlink" title="ServiceFactory接口"></a>ServiceFactory接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getService</span><span class="params">(Class&lt;T&gt; serviceInterface)</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title">getService</span><span class="params">(Class&lt;T&gt; serviceInterface, <span class="keyword">int</span> timeout)</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title">getService</span><span class="params">(Class&lt;T&gt; serviceInterface, ServiceCallback callback)</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title">getService</span><span class="params">(Class&lt;T&gt; serviceInterface, ServiceCallback callback, <span class="keyword">int</span> timeout)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title">getService</span><span class="params">(String url, Class&lt;T&gt; serviceInterface)</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title">getService</span><span class="params">(String url, Class&lt;T&gt; serviceInterface, <span class="keyword">int</span> timeout)</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title">getService</span><span class="params">(String url, Class&lt;T&gt; serviceInterface, InvocationCallback callback)</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title">getService</span><span class="params">(String url, Class&lt;T&gt; serviceInterface, InvocationCallback callback, <span class="keyword">int</span> timeout)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment">* add the service to pigeon and publish the service to registry</span></span></span><br><span class="line"><span class="function"><span class="comment">*</span></span></span><br><span class="line"><span class="function"><span class="comment">* @param serviceInterface</span></span></span><br><span class="line"><span class="function"><span class="comment">* @param service</span></span></span><br><span class="line"><span class="function"><span class="comment">* @throws RpcException</span></span></span><br><span class="line"><span class="function"><span class="comment">*/</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title">addService</span><span class="params">(Class&lt;T&gt; serviceInterface, T service)</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment">* add the service to pigeon and publish the service to registry</span></span></span><br><span class="line"><span class="function"><span class="comment">*</span></span></span><br><span class="line"><span class="function"><span class="comment">* @param url</span></span></span><br><span class="line"><span class="function"><span class="comment">* @param serviceInterface</span></span></span><br><span class="line"><span class="function"><span class="comment">* @param service</span></span></span><br><span class="line"><span class="function"><span class="comment">* @throws RpcException</span></span></span><br><span class="line"><span class="function"><span class="comment">*/</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title">addService</span><span class="params">(String url, Class&lt;T&gt; serviceInterface, T service)</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment">* add the service to pigeon and publish the service to registry</span></span></span><br><span class="line"><span class="function"><span class="comment">*</span></span></span><br><span class="line"><span class="function"><span class="comment">* @param url</span></span></span><br><span class="line"><span class="function"><span class="comment">* @param serviceInterface</span></span></span><br><span class="line"><span class="function"><span class="comment">* @param service</span></span></span><br><span class="line"><span class="function"><span class="comment">* @param port</span></span></span><br><span class="line"><span class="function"><span class="comment">* @throws RpcException</span></span></span><br><span class="line"><span class="function"><span class="comment">*/</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title">addService</span><span class="params">(String url, Class&lt;T&gt; serviceInterface, T service, <span class="keyword">int</span> port)</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment">* add the service to pigeon and publish the service to registry</span></span></span><br><span class="line"><span class="function"><span class="comment">*</span></span></span><br><span class="line"><span class="function"><span class="comment">* @param providerConfig</span></span></span><br><span class="line"><span class="function"><span class="comment">* @throws RpcException</span></span></span><br><span class="line"><span class="function"><span class="comment">*/</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title">addService</span><span class="params">(ProviderConfig&lt;T&gt; providerConfig)</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment">* add the services to pigeon and publish these services to registry</span></span></span><br><span class="line"><span class="function"><span class="comment">*</span></span></span><br><span class="line"><span class="function"><span class="comment">* @param providerConfigList</span></span></span><br><span class="line"><span class="function"><span class="comment">* @throws RpcException</span></span></span><br><span class="line"><span class="function"><span class="comment">*/</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addServices</span><span class="params">(List&lt;ProviderConfig&lt;?&gt;&gt; providerConfigList)</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment">* publish the service to registry</span></span></span><br><span class="line"><span class="function"><span class="comment">*</span></span></span><br><span class="line"><span class="function"><span class="comment">* @param providerConfig</span></span></span><br><span class="line"><span class="function"><span class="comment">* @throws RpcException</span></span></span><br><span class="line"><span class="function"><span class="comment">*/</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title">publishService</span><span class="params">(ProviderConfig&lt;T&gt; providerConfig)</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment">* publish the service to registry</span></span></span><br><span class="line"><span class="function"><span class="comment">*</span></span></span><br><span class="line"><span class="function"><span class="comment">* @param url</span></span></span><br><span class="line"><span class="function"><span class="comment">* @throws RpcException</span></span></span><br><span class="line"><span class="function"><span class="comment">*/</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title">publishService</span><span class="params">(String url)</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment">* unpublish the service from registry</span></span></span><br><span class="line"><span class="function"><span class="comment">*</span></span></span><br><span class="line"><span class="function"><span class="comment">* @param providerConfig</span></span></span><br><span class="line"><span class="function"><span class="comment">* @throws RpcException</span></span></span><br><span class="line"><span class="function"><span class="comment">*/</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title">unpublishService</span><span class="params">(ProviderConfig&lt;T&gt; providerConfig)</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment">* unpublish the service from registry</span></span></span><br><span class="line"><span class="function"><span class="comment">*</span></span></span><br><span class="line"><span class="function"><span class="comment">* @param url</span></span></span><br><span class="line"><span class="function"><span class="comment">* @throws RpcException</span></span></span><br><span class="line"><span class="function"><span class="comment">*/</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title">unpublishService</span><span class="params">(String url)</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment">* unpublish all pigeon services from registry</span></span></span><br><span class="line"><span class="function"><span class="comment">*</span></span></span><br><span class="line"><span class="function"><span class="comment">* @throws RpcException</span></span></span><br><span class="line"><span class="function"><span class="comment">*/</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unpublishAllServices</span><span class="params">()</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment">* publish all pigeon services to registry</span></span></span><br><span class="line"><span class="function"><span class="comment">*</span></span></span><br><span class="line"><span class="function"><span class="comment">* @throws RpcException</span></span></span><br><span class="line"><span class="function"><span class="comment">*/</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">publishAllServices</span><span class="params">()</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment">* remove all pigeon services, including unregister these services from</span></span></span><br><span class="line"><span class="function"><span class="comment">* registry</span></span></span><br><span class="line"><span class="function"><span class="comment">*</span></span></span><br><span class="line"><span class="function"><span class="comment">* @throws RpcException</span></span></span><br><span class="line"><span class="function"><span class="comment">*/</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeAllServices</span><span class="params">()</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment">* remove the service from pigeon, including unregister this service from</span></span></span><br><span class="line"><span class="function"><span class="comment">* registry</span></span></span><br><span class="line"><span class="function"><span class="comment">*</span></span></span><br><span class="line"><span class="function"><span class="comment">* @param url</span></span></span><br><span class="line"><span class="function"><span class="comment">* @throws RpcException</span></span></span><br><span class="line"><span class="function"><span class="comment">*/</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeService</span><span class="params">(String url)</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment">* remove the service from pigeon, including unregister this service from</span></span></span><br><span class="line"><span class="function"><span class="comment">* registry</span></span></span><br><span class="line"><span class="function"><span class="comment">*</span></span></span><br><span class="line"><span class="function"><span class="comment">* @param providerConfig</span></span></span><br><span class="line"><span class="function"><span class="comment">* @throws RpcException</span></span></span><br><span class="line"><span class="function"><span class="comment">*/</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title">removeService</span><span class="params">(ProviderConfig&lt;T&gt; providerConfig)</span> <span class="keyword">throws</span> RpcException</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setServerWeight</span><span class="params">(<span class="keyword">int</span> weight)</span> <span class="keyword">throws</span> RegistryException</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">online</span><span class="params">()</span> <span class="keyword">throws</span> RegistryException</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> <span class="keyword">throws</span> RegistryException</span></span><br></pre></td></tr></table></figure>
<h2 id="序列化支持"><a href="#序列化支持" class="headerlink" title="序列化支持"></a>序列化支持</h2><p>pigeon支持多种序列化方式，序列化方式只需要在客户端调用时通过serialize属性指定，一般情况推荐兼容性最好的hessian。<br>如果需要自行设计序列化方式，可以继承<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.dianping.pigeon.remoting.common.codec.DefaultAbstractSerializer</span><br></pre></td></tr></table></figure></p>
<p>类来定义自己的序列化类，并通过<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SerializerFactory.registerSerializer(<span class="keyword">byte</span> serializerType, Serializer serializer)</span><br></pre></td></tr></table></figure></p>
<p>接口将自定义的序列化类注册进来。</p>
<h3 id="protobuf3序列化支持"><a href="#protobuf3序列化支持" class="headerlink" title="protobuf3序列化支持"></a>protobuf3序列化支持</h3><p>客户端配置将序列化方式指定为protobuf3，如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"testService"</span> <span class="attr">class</span>=<span class="string">"com.dianping.pigeon.remoting.invoker.config.spring.ReferenceBean"</span> <span class="attr">init-method</span>=<span class="string">"init"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"com.dianping.midas.query.api.message.TestService"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"interfaceName"</span> <span class="attr">value</span>=<span class="string">"com.dianping.midas.query.api.message.TestService"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serialize"</span> <span class="attr">value</span>=<span class="string">"protobuf3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>需要注意的是：方法的参数和返回值的类型，必须都为protobuf生成的类。<br>具体可参考官方文档：<a href="https://developers.google.com/protocol-buffers/docs/javatutorial" target="_blank" rel="noopener">protobuf-java</a></p>
<h2 id="HTTP协议支持"><a href="#HTTP协议支持" class="headerlink" title="HTTP协议支持"></a>HTTP协议支持</h2><p>pigeon目前支持2种协议：default和http。</p>
<p>default是pigeon默认的基于tcp方式的调用方式。</p>
<p>pigeon也支持http调用，这样可以允许非java的应用调用pigeon的服务。对于http调用，服务端不需要任何修改，任何一个pigeon的服务启动之后，都会同时支持目前默认的基于tcp的和基于http的服务调用，只需要客户端修改配置即可实现http方式的调用。</p>
<p>http协议的默认端口是4080，目前不可配置，如果被占用，会自动选择其他端口。</p>
<p>如果想通过http调用pigeon服务，可以通过http发送post请求调用pigeon服务，可以采用json或hessian的序列化格式:</p>
<p>a) 可以将请求内容post到<a href="http://ip:4080/service" target="_blank" rel="noopener">http://ip:4080/service</a>, 并且在header里设置serialize参数为7或2。</p>
<p>b) 如果是json序列化可以post到<a href="http://ip:4080/service?serialize=7" target="_blank" rel="noopener">http://ip:4080/service?serialize=7</a>, 如果是hessian序列化请post到<a href="http://ip:4080/service?serialize=2" target="_blank" rel="noopener">http://ip:4080/service?serialize=2</a>.</p>
<h3 id="POST方式"><a href="#POST方式" class="headerlink" title="POST方式"></a>POST方式</h3><p>POST地址：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ip:4080/service?serialize=7</span><br></pre></td></tr></table></figure></p>
<p>JSON请求：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;  </span><br><span class="line">    <span class="string">"seq"</span>:<span class="number">-985</span>,</span><br><span class="line">    <span class="string">"serialize"</span>:<span class="number">7</span>,</span><br><span class="line">    <span class="string">"callType"</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="string">"timeout"</span>:<span class="number">1000</span>,</span><br><span class="line">    <span class="string">"methodName"</span>:<span class="string">"echo"</span>,</span><br><span class="line">    <span class="string">"parameters"</span>:[  </span><br><span class="line">        <span class="string">"echoService_492"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"messageType"</span>:<span class="number">2</span>,</span><br><span class="line">    <span class="string">"url"</span>:<span class="string">"com.dianping.pigeon.demo.EchoService"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>返回：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;  </span><br><span class="line">    <span class="string">"seq"</span>:<span class="number">-985</span>,</span><br><span class="line">    <span class="string">"messageType"</span>:<span class="number">2</span>,</span><br><span class="line">    <span class="string">"context"</span>:<span class="literal">null</span>,</span><br><span class="line">    <span class="string">"exception"</span>:<span class="literal">null</span>,</span><br><span class="line">    <span class="string">"response"</span>:<span class="string">"echo:echoService_492"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果参数List<t>类型：<br>JSON请求：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"seq"</span>: <span class="number">-146</span>,</span><br><span class="line">    <span class="string">"serialize"</span>: <span class="number">7</span>,</span><br><span class="line">    <span class="string">"callType"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"timeout"</span>: <span class="number">2000</span>,</span><br><span class="line">    <span class="string">"methodName"</span>: <span class="string">"getUserDetail"</span>,</span><br><span class="line">    <span class="string">"parameters"</span>: [</span><br><span class="line">        [<span class="string">"java.util.List"</span>, [&#123;</span><br><span class="line">            <span class="string">"@class"</span>: <span class="string">"com.dianping.pigeon.demo.UserService$User"</span>,</span><br><span class="line">            <span class="string">"username"</span>: <span class="string">"user_73"</span></span><br><span class="line">        &#125;, &#123;</span><br><span class="line">            <span class="string">"@class"</span>: <span class="string">"com.dianping.pigeon.demo.UserService$User"</span>,</span><br><span class="line">            <span class="string">"username"</span>: <span class="string">"user_74"</span></span><br><span class="line">        &#125;]], <span class="literal">false</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"messageType"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"com.dianping.pigeon.demo.UserService"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></t></p>
<p>返回：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"seq"</span>: <span class="number">-146</span>,</span><br><span class="line">    <span class="string">"messageType"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">"context"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="string">"exception"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="string">"response"</span>: [<span class="string">"[Lcom.dianping.pigeon.demo.UserService$User;"</span>, [&#123;</span><br><span class="line">        <span class="string">"username"</span>: <span class="string">"user_73"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="string">"password"</span>: <span class="literal">null</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="string">"username"</span>: <span class="string">"user_74"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="string">"password"</span>: <span class="literal">null</span></span><br><span class="line">    &#125;]]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="GET方式"><a href="#GET方式" class="headerlink" title="GET方式"></a>GET方式</h3><p>GET URL：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ip:4080/invoke.json?url=http://service.dianping.com/com.dianping.pigeon.demo.EchoService&amp;method=echo&amp;parameterTypes=java.lang.String&amp;parameters=abc</span><br></pre></td></tr></table></figure></p>
<ul>
<li>url：服务地址</li>
<li>method：服务方法</li>
<li>parameterTypes：服务方法method的参数类型，如果是多个参数就写多个parameterTypes</li>
<li>parameters：参数值，多个参数值就写多个parameters</li>
</ul>
<p>如果参数类型是enum类型，参数值要传某个enum值，请传递该值在enum里的定义顺序，如enum的第1个值就传0，第2个值就传1。</p>
<p>如果是多个参数，比如某个方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">String <span class="title">echo2</span><span class="params">(String input, <span class="keyword">int</span> size)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>URL示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:4080/invoke.json?url=http://service.dianping.com/com.dianping.pigeon.demo.EchoService&amp;method=echo2&amp;parameterTypes=java.lang.String&amp;parameters=wux&amp;parameterTypes=int&amp;parameters=2</span><br></pre></td></tr></table></figure></p>
<p>如果服务方法参数类型是Collection泛型，如List<user>，需要在参数值指定@class类型，比如这个方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getUserDetail(List&lt;User&gt; userList, <span class="keyword">boolean</span> flag)</span><br></pre></td></tr></table></figure></user></p>
<p>的userList变量，需要传参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">    &quot;@class&quot;: &quot;com.dianping.pigeon.demo.UserService$User&quot;,</span><br><span class="line">    &quot;username&quot;: &quot;user_73&quot;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    &quot;@class&quot;: &quot;com.dianping.pigeon.demo.UserService$User&quot;,</span><br><span class="line">    &quot;username&quot;: &quot;user_74&quot;</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure></p>
<p>以上json格式需符合jackson的json规范，如果不清楚一个对象对应的json字符串，pigeon提供接口可以得到对象转换后的json字符串。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">	User user = <span class="keyword">new</span> User();</span><br><span class="line">	user.setUsername(<span class="string">"scott"</span>);</span><br><span class="line">	List&lt;User&gt; users = <span class="keyword">new</span> ArrayList&lt;User&gt;();</span><br><span class="line">	users.add(user);</span><br><span class="line">	JacksonSerializer serializer = <span class="keyword">new</span> JacksonSerializer();</span><br><span class="line">	String str = serializer.serializeObject(users);</span><br><span class="line">	System.out.println(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="服务测试工具"><a href="#服务测试工具" class="headerlink" title="服务测试工具"></a>服务测试工具</h2><p>pigeon提供了服务测试的工具，测试工具基于pigeon的http协议(默认在4080端口)，可以访问每一台服务器的url：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ip:4080/services</span><br></pre></td></tr></table></figure></p>
<p>页面上会列出该服务器上所有的pigeon服务列表，对于每一个服务方法，可以在右侧输入json格式的参数，进行服务调用，获取json格式的返回结果。</p>
<p>如果不清楚一个对象对应的json字符串，可以参考前面一节，pigeon提供接口可以得到对象转换后的json字符串。</p>
<p>在线上环境进行测试时，需要输入验证码，验证码可以从该ip的pigeon日志文件中获取，请务必谨慎使用该测试工具，以免人为失误影响线上数据。</p>
<p>如果服务方法参数类型是Collection泛型，如<code>List&lt;User&gt;</code>，需要在参数值指定@class类型，比如这个方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getUserDetail(List&lt;User&gt; userList, boolean flag)</span><br></pre></td></tr></table></figure></p>
<p>的userList变量，需要传参数：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">    <span class="string">"@class"</span>: <span class="string">"com.dianping.pigeon.demo.UserService$User"</span>,</span><br><span class="line">    <span class="string">"username"</span>: <span class="string">"wux"</span>,</span><br><span class="line">    <span class="string">"email"</span>: <span class="string">"scott@dianping.com"</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure></p>
<p>如果服务方法参数类型是Map泛型，如<code>Map&lt;User, Double&gt;</code>，需要符合这种格式：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"&#123;\"@class\":\"com.dianping.pigeon.demo.UserService$User\",\"username\":\"w\",\"email\":null,\"password\":null&#125;"</span>: <span class="number">4.5</span>,</span><br><span class="line">    <span class="string">"&#123;\"username\":\"x\",\"email\":null,\"password\":null&#125;"</span>: <span class="number">3.5</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>访问<code>http://ip:4080/services.json</code>可以返回该服务器所有服务列表的json内容。</p>
<p>访问<code>http://ip:4080/invoke.json</code>可以通过get方式测试服务，例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:4080/invoke.json?url=http://service.dianping.com/com.dianping.pigeon.demo.EchoService&amp;method=echo&amp;parameterTypes=java.lang.String&amp;parameters=abc</span><br></pre></td></tr></table></figure></p>
<ul>
<li>url参数是服务地址</li>
<li>method是服务方法</li>
<li>parameterTypes是服务方法method的参数类型，如果是多个参数就写多个parameterTypes</li>
<li>parameters是参数值，多个参数值就写多个parameters</li>
</ul>
<p>如果参数类型是enum类型，参数值要传某个enum值，请传递该值在enum里的定义顺序，如enum的第1个值就传0，第2个值就传1。</p>
<p>如果是多个参数，比如某个方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">String <span class="title">echo2</span><span class="params">(String input, <span class="keyword">int</span> size)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>url示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:4080/invoke.json?url=http://service.dianping.com/com.dianping.pigeon.demo.EchoService&amp;method=echo2&amp;parameterTypes=java.lang.String&amp;parameters=wux&amp;parameterTypes=int&amp;parameters=2</span><br></pre></td></tr></table></figure></p>
<p>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo2(Map&lt;User, Double&gt; userMap, <span class="keyword">int</span> count)</span><br></pre></td></tr></table></figure></p>
<p>url示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:4080/invoke.json?url=http://service.dianping.com/com.dianping.pigeon.demo.EchoService&amp;method=echo2&amp;parameterTypes=java.util.Map&amp;parameters=&#123;&quot;&#123;\&quot;@class\&quot;:\&quot;com.dianping.pigeon.demo.UserService$User\&quot;,\&quot;username\&quot;:\&quot;w\&quot;,\&quot;email\&quot;:null,\&quot;password\&quot;:null&#125;&quot;:4.5,&quot;&#123;\&quot;@class\&quot;:\&quot;com.dianping.pigeon.demo.UserService$User\&quot;,\&quot;username\&quot;:\&quot;x\&quot;&#125;&quot;:3.5&#125;&amp;parameterTypes=int&amp;parameters=3&amp;direct=false</span><br></pre></td></tr></table></figure></p>
<p>如果需要每次调用都记录cat日志，需要带上direct=false参数</p>
<p><a href="http://ip:4080/services.status" target="_blank" rel="noopener">http://ip:4080/services.status</a> 可以测试服务健康状况</p>
<h2 id="配置负载均衡策略"><a href="#配置负载均衡策略" class="headerlink" title="配置负载均衡策略"></a>配置负载均衡策略</h2><h3 id="配置客户端的loadBalance属性"><a href="#配置客户端的loadBalance属性" class="headerlink" title="配置客户端的loadBalance属性"></a>配置客户端的loadBalance属性</h3><p>目前可以是random/roundRobin/weightedAutoware这几种类型，默认是weightedAutoware策略，一般场景不建议修改。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"echoService"</span> <span class="attr">class</span>=<span class="string">"com.dianping.pigeon.remoting.invoker.config.spring.ReferenceBean"</span>	<span class="attr">init-method</span>=<span class="string">"init"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"http://service.dianping.com/com.dianping.pigeon.demo.EchoService"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"interfaceName"</span> <span class="attr">value</span>=<span class="string">"com.dianping.pigeon.demo.EchoService"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"callType"</span> <span class="attr">value</span>=<span class="string">"sync"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeout"</span> <span class="attr">value</span>=<span class="string">"1000"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"loadBalance"</span> <span class="attr">value</span>=<span class="string">"weightedAutoware"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="运行中动态配置客户端的loadBalance属性"><a href="#运行中动态配置客户端的loadBalance属性" class="headerlink" title="运行中动态配置客户端的loadBalance属性"></a>运行中动态配置客户端的loadBalance属性</h3><p>在客户端应用xxx的lion管理端，添加配置项xxx.pigeon.loadbalance.dynamictype，内容为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"com.dianping.arch.test.benchmark.service.EchoService#echo"</span> : <span class="string">"random"</span>,</span><br><span class="line">    <span class="string">"com.dianping.arch.test.benchmark.service.TestService"</span> : <span class="string">"autoaware"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>优先级是method级别的loadbalance，然后到service级别的loadbalance，最后是应用静态配置的loadbalance。</p>
<h2 id="客户端配置某个方法的超时时间"><a href="#客户端配置某个方法的超时时间" class="headerlink" title="客户端配置某个方法的超时时间"></a>客户端配置某个方法的超时时间</h2><p>pigeon支持客户端调用某个服务接口时，对整个服务的超时时间进行设置，也可以对该服务接口的某个方法设置单独的超时时间，没有配置超时的方法会以服务级别的超时时间为准。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">    	<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> </span></span><br><span class="line"><span class="tag">    	<span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">	    <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span> </span></span><br><span class="line"><span class="tag">	    <span class="attr">xmlns:pigeon</span>=<span class="string">"http://code.dianping.com/schema/pigeon"</span></span></span><br><span class="line"><span class="tag">	    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">	    http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">	    http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">	    http://code.dianping.com/schema/pigeon http://code.dianping.com/schema/pigeon/pigeon-service-2.0.xsd"</span>&gt;</span></span><br><span class="line">	    </span><br><span class="line">	<span class="tag">&lt;<span class="name">pigeon:reference</span> <span class="attr">id</span>=<span class="string">"echoService"</span> <span class="attr">timeout</span>=<span class="string">"1000"</span> <span class="attr">url</span>=<span class="string">"http://service.dianping.com/com.dianping.pigeon.demo.EchoService"</span> <span class="attr">interface</span>=<span class="string">"com.dianping.pigeon.demo.EchoService"</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">pigeon:method</span> <span class="attr">name</span>=<span class="string">"echo"</span> <span class="attr">timeout</span>=<span class="string">"2000"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">pigeon:reference</span>&gt;</span></span><br><span class="line">	</span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>如果想设置当前线程下一个pigeon方法调用的超时时间，可以调用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InvokerHelper.setTimeout(<span class="number">200</span>);</span><br></pre></td></tr></table></figure></p>
<h2 id="服务隔离与限流"><a href="#服务隔离与限流" class="headerlink" title="服务隔离与限流"></a>服务隔离与限流</h2><h3 id="配置服务方法级别的最大并发数"><a href="#配置服务方法级别的最大并发数" class="headerlink" title="配置服务方法级别的最大并发数"></a>配置服务方法级别的最大并发数</h3><p>pigeon支持服务端对某个服务接口的方法的最大并发数进行配置，这样可以隔离每个服务方法的访问，防止某些方法执行太慢导致服务端线程池全部卡住的问题。</p>
<p>1、客户端spring配置</p>
<p>只需要设置useSharedPool为false，pigeon就会为每个方法设置独立的线程池执行请求。</p>
<p>如果并发超过设置的最大并发数，服务端会抛出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.dianping.pigeon.remoting.common.exception.RejectedException</span><br></pre></td></tr></table></figure>
<p>异常，客户端也会收到这个异常。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 定义pool --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pigeon:pool</span> <span class="attr">id</span>=<span class="string">"poolS"</span></span></span><br><span class="line"><span class="tag"><span class="attr">corePoolSize</span>=<span class="string">"$&#123;tena.test.core.size&#125;"</span></span></span><br><span class="line"><span class="tag"><span class="attr">maxPoolSize</span>=<span class="string">"$&#123;tena.test.max.size&#125;"</span></span></span><br><span class="line"><span class="tag"><span class="attr">workQueueSize</span>=<span class="string">"$&#123;tena.test.queue.size&#125;"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pigeon:pool</span> <span class="attr">id</span>=<span class="string">"poolM"</span></span></span><br><span class="line"><span class="tag"><span class="attr">corePoolSize</span>=<span class="string">"$&#123;pigeon-benchmark.isolation.core.size&#125;"</span></span></span><br><span class="line"><span class="tag"><span class="attr">maxPoolSize</span>=<span class="string">"$&#123;pigeon-benchmark.isolation.max.size&#125;"</span></span></span><br><span class="line"><span class="tag"><span class="attr">workQueueSize</span>=<span class="string">"$&#123;pigeon-benchmark.isolation.queue.size&#125;"</span> /&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">&lt;!-- 引用pool --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pigeon:service</span> <span class="attr">interface</span>=<span class="string">"com.dianping.pigeon.benchmark.service.HelloService"</span></span></span><br><span class="line"><span class="tag"><span class="attr">url</span>=<span class="string">"com.dianping.pigeon.benchmark.service.HelloService"</span></span></span><br><span class="line"><span class="tag"><span class="attr">pool</span>=<span class="string">"poolS"</span> <span class="attr">useSharedPool</span>=<span class="string">"false"</span> <span class="attr">ref</span>=<span class="string">"helloService"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pigeon:method</span> <span class="attr">name</span>=<span class="string">"sayHello"</span> <span class="attr">pool</span>=<span class="string">"poolM"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pigeon:service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pigeon:service</span> <span class="attr">interface</span>=<span class="string">"com.dianping.pigeon.benchmark.service.TestService"</span></span></span><br><span class="line"><span class="tag"><span class="attr">url</span>=<span class="string">"com.dianping.pigeon.benchmark.service.TestService"</span></span></span><br><span class="line"><span class="tag"><span class="attr">pool</span>=<span class="string">"poolM"</span> <span class="attr">useSharedPool</span>=<span class="string">"false"</span> <span class="attr">ref</span>=<span class="string">"testService"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pigeon:method</span> <span class="attr">name</span>=<span class="string">"sendLong"</span> <span class="attr">pool</span>=<span class="string">"poolS"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pigeon:service</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>需要设置useSharedPool为false，pool定义中的corePoolSize、maxPoolSize、workQueueSize均可动态改变生效</p>
<p>2、配置中心统一配置</p>
<p>a、首先需要在应用lion里配置开关打开，例如xxx-service项目要配置以下lion配置：</p>
<p>xxx-service.pigeon.provider.pool.config.switch=true</p>
<p>b、配置应用的自定义pool(与方法1中的pool无关)，添加配置项：</p>
<p>xxx-service.pigeon.provider.pool.config</p>
<p>内容为json格式的pool对象数组，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[ &#123;</span><br><span class="line"> &quot;poolName&quot; : &quot;pool1&quot;,</span><br><span class="line"> &quot;corePoolSize&quot; : 50,</span><br><span class="line"> &quot;maxPoolSize&quot; : 100,</span><br><span class="line"> &quot;workQueueSize&quot; : 101</span><br><span class="line">&#125;, &#123;</span><br><span class="line"> &quot;poolName&quot; : &quot;pool2&quot;,</span><br><span class="line"> &quot;corePoolSize&quot; : 1,</span><br><span class="line"> &quot;maxPoolSize&quot; : 2,</span><br><span class="line"> &quot;workQueueSize&quot; : 33</span><br><span class="line">&#125;, &#123;</span><br><span class="line"> &quot;poolName&quot; : &quot;pool3&quot;,</span><br><span class="line"> &quot;corePoolSize&quot; : 0,</span><br><span class="line"> &quot;maxPoolSize&quot; : 1,</span><br><span class="line"> &quot;workQueueSize&quot; : 1</span><br><span class="line">&#125; ]</span><br></pre></td></tr></table></figure></p>
<p>c、配置应用的接口与使用的自定义pool的映射，支持服务或方法级别，添加而配置项：</p>
<p>pigeon-benchmark.pigeon.provider.pool.api.config</p>
<p>内容为json格式的映射对象，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> &quot;com.dianping.pigeon.benchmark.service.HelloService#statistics&quot; : &quot;pool1&quot;,</span><br><span class="line"> &quot;com.dianping.pigeon.benchmark.service.EchoService&quot; : &quot;pool2&quot;,</span><br><span class="line"> &quot;com.dianping.pigeon.benchmark.service.TestService&quot; : &quot;pool3&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>d、以上a、b、c的配置项都可以动态生效。</p>
<p>3、管理端配置</p>
<p>服务隔离的配置也可通过管理端进行</p>
<h3 id="限制某个客户端应用的最大并发数"><a href="#限制某个客户端应用的最大并发数" class="headerlink" title="限制某个客户端应用的最大并发数"></a>限制某个客户端应用的最大并发数</h3><p>1、应用级限流</p>
<p>pigeon支持在服务端配置某个客户端应用的最大请求QPS</p>
<p>首先需要在应用lion里配置开关打开，例如deal-service项目要配置以下lion配置： deal-service.pigeon.provider.applimit.enable=true</p>
<p>配置客户端应用对应的最大QPS： pigeon.provider.applimit=tuangou-web:100,xxx:50,yyy:100 如果客户端请求QPS超过了设置的阀值，服务端会返回com.dianping.pigeon.remoting.common.exception.RejectedException给客户端，客户端会收到RejectedException</p>
<p>2、配置某个接口方法对应的客户端应用的最大QPS:</p>
<p>首先打开开关：xxx-service.pigeon.provider.methodapplimit.active=true</p>
<p>增加配置项：xxx-service.pigeon.provider.methodapplimit</p>
<p>配置内容为json格式：{ “api#method” : { “app1”: 100, “app2”: 50} }</p>
<p>例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;http://service.dianping.com/com.dianping.pigeon.demo.EchoService#echo&quot;: &#123; &quot;account-service&quot;: 2000, &quot;deal-server&quot;: 5000&#125; &#125;</span><br></pre></td></tr></table></figure></p>
<p>3、配置服务端的总体最大QPS：</p>
<p>首先打开开关：xxx-service.pigeon.provider.globallimit.enable=true</p>
<p>增加配置项：xxx-service.pigeon.provider.globallimit=5000</p>
<p>4、其他:</p>
<p>以上配置第一次配置了之后，均可以通过lion动态在线设置实时生效</p>
<h2 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h2><p>pigeon在调用端提供了服务降级功能支持</p>
<p>应用调用远端的服务接口如果在最近一段时间内出现连续的调用失败，失败率超过一定阀值，可以自动触发或手工触发降级，调用端直接返回默认对象或抛出异常，不会将调用请求发到服务提供方，如果服务提供方恢复可用，客户端可以自动或手工解除降级</p>
<h3 id="配置接口的降级策略"><a href="#配置接口的降级策略" class="headerlink" title="配置接口的降级策略"></a>配置接口的降级策略</h3><p>例如xxx-service项目，有<a href="http://service.dianping.com/com.dianping.pigeon.demo.EchoService这个服务，包含3个方法：" target="_blank" rel="noopener">http://service.dianping.com/com.dianping.pigeon.demo.EchoService这个服务，包含3个方法：</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String echo(String input);</span><br><span class="line">User getUserDetail(String userName);</span><br><span class="line">User[] getUserDetailArray(String[] usernames);</span><br></pre></td></tr></table></figure></p>
<h3 id="配置可降级的方法"><a href="#配置可降级的方法" class="headerlink" title="配置可降级的方法"></a>配置可降级的方法</h3><p>要配置以下lion配置：</p>
<p>a、增加lion配置：xxx-service.pigeon.invoker.degrade.methods配置为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://service.dianping.com/com.dianping.pigeon.demo.EchoService#echo=a,http://service.dianping.com/com.dianping.pigeon.demo.EchoService#getUserDetail=b,http://service.dianping.com/com.dianping.pigeon.demo.EchoService#getUserDetailArray=c</span><br></pre></td></tr></table></figure></p>
<p>上述配置内容包含多个方法的降级策略a、b、c。如果某此调用需要降级，而降级策略没有配置则不降级，进行正常调用流程。</p>
<p>b、增加lion配置：pigeon-test.pigeon.invoker.degrade.method.return.a对应echo方法的默认返回，配置为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;returnClass&quot;:&quot;java.lang.String&quot;,&quot;content&quot;:&quot;echo,input&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果不想返回默认值，而是抛出一个降级异常（pigeon默认会抛出com.dianping.pigeon.remoting.invoker.exception.ServiceDegradedException），配置为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;throwException&quot;:&quot;true&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>c、增加lion配置：pigeon-test.pigeon.invoker.degrade.method.return.b对应getUserDetail方法的默认返回，配置为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;returnClass&quot;:&quot;com.dianping.pigeon.demo.User&quot;,&quot;content&quot;:&quot;&#123;\&quot;username\&quot;:\&quot;user-1\&quot;&#125;&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>d、增加lion配置：pigeon-test.pigeon.invoker.degrade.method.return.c对应getUserDetailArray方法的默认返回，配置为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;returnClass&quot;:&quot;[Lcom.dianping.pigeon.demo.UserService$User;&quot;,&quot;content&quot;:&quot;[&#123;\&quot;username\&quot;:\&quot;array-1\&quot;&#125;,&#123;\&quot;username\&quot;:\&quot;array-2\&quot;&#125;]&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里返回对象是数组，如果是返回集合，也类似，例如返回一个LinkedList：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;returnClass&quot;:&quot;java.util.LinkedList&quot;,&quot;content&quot;:&quot;[&#123;\&quot;@class\&quot;:\&quot;com.dianping.pigeon.demo.UserService$User\&quot;,\&quot;username\&quot;:\&quot;list-1\&quot;&#125;,&#123;\&quot;username\&quot;:\&quot;list-2\&quot;&#125;]&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>e、使用groovy脚本的方式，增加lion配置:pigeon-test.pigeon.invoker.degrade.method.return.a，其中content对应echo方法的默认groovy脚本，配置为：<br>可以执行任意脚本，例如抛出异常：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;useGroovyScript&quot;:&quot;true&quot;, &quot;content&quot;:&quot;throw new RuntimeException(&apos;test groovy degrade&apos;);&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>或者返回对象：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;useGroovyScript&quot;:&quot;true&quot;, &quot;content&quot;:&quot;return new com.dianping.pigeon.remoting.test.Person(name:&apos;zhangsan&apos;,age:1);&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意！脚本的最后一条执行语句，必须返回方法的返回值类型或抛出异常。</p>
<p>f、除了上述几种使用lion配置降级策略的方式，pigeon还提供了一种使用mock类的降级配置方式。</p>
<p>例如我们想修改pigeon-test.pigeon.invoker.degrade.method.return.a的降级策略方式为mock方式，只需修改配置为：</p>
<p>{“useMockClass”:”true”}</p>
<p>打开mock开关，然后在spring的xml配置中添加mock类的引用对象：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"echoService"</span> <span class="attr">class</span>=<span class="string">"com.dianping.pigeon.remoting.invoker.config.spring.ReferenceBean"</span> <span class="attr">init-method</span>=<span class="string">"init"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"com.dianping.pigeon.benchmark.service.EchoService"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"interfaceName"</span> <span class="attr">value</span>=<span class="string">"com.dianping.pigeon.benchmark.service.EchoService"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mock"</span> <span class="attr">ref</span>=<span class="string">"echoServiceMock"</span> /&gt;</span><span class="comment">&lt;!-- 添加mock类的引用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 必须实现EchoService接口 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"echoServiceMock"</span> <span class="attr">class</span>=<span class="string">"com.dianping.pigeon.benchmark.service.EchoServiceMock"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>g、若想在开启了降级总开关的基础上，开启或关闭部分接口的降级开关，可在json配置中添加配置项”enable”:”false”或”enable”:”true”，不填写则缺省为true<br>例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;enable&quot;:&quot;false&quot;, &quot;useGroovyScript&quot;:&quot;true&quot;, &quot;content&quot;:&quot;if (new Random().nextInt(2) &lt; 1) &#123; return &apos;normal&apos;; &#125; else &#123; throw new RuntimeException(&apos;test groovy degrade&apos;); &#125;&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>h、降级配置方式的优先级为：mock &gt; groovy script &gt; json exception &gt; json default value</p>
<h3 id="强制降级开关"><a href="#强制降级开关" class="headerlink" title="强制降级开关"></a>强制降级开关</h3><p>强制降级开关只是在远程服务大量超时或其他不可用情况时，紧急时候进行设置，开启后，调用端会根据上述降级策略直接返回默认值或抛出降级异常，当远程服务恢复后，建议关闭此开关</p>
<p>提供了pigeon.invoker.degrade.force配置开关，例如xxx-service项目要配置以下lion配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx-service.pigeon.invoker.degrade.force=true，默认为false</span><br></pre></td></tr></table></figure></p>
<h3 id="失败降级开关"><a href="#失败降级开关" class="headerlink" title="失败降级开关"></a>失败降级开关</h3><p>失败降级开关便于客户端在服务端出现非业务异常(比如网络失败，超时，无可用节点等)时进行降级容错，而在出现业务异常(比如登录用户名密码错误)时不需要降级。</p>
<p>提供了pigeon.invoker.degrade.failure配置开关，例如xxx-service项目要配置以下lion配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx-service.pigeon.invoker.degrade.failure=true，默认为false</span><br></pre></td></tr></table></figure></p>
<h3 id="自动降级开关"><a href="#自动降级开关" class="headerlink" title="自动降级开关"></a>自动降级开关</h3><p>自动降级开关是在调用端设置，开启自动降级后，调用端如果调用某个服务出现连续的超时或不可用，当一段时间内（10秒内）失败率超过一定阀值（默认1%）会触发自动降级，调用端会根据上述降级策略直接返回默认值或抛出降级异常</p>
<p>当服务端恢复后，调用端会自动解除降级模式，再次发起请求到远程服务</p>
<p>提供了pigeon.invoker.degrade.auto配置开关，例如xxx-service项目要配置以下lion配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx-service.pigeon.invoker.degrade.auto=true，默认为false</span><br></pre></td></tr></table></figure></p>
<h3 id="降级开关的优先级-在同时打开的时候的有效性"><a href="#降级开关的优先级-在同时打开的时候的有效性" class="headerlink" title="降级开关的优先级(在同时打开的时候的有效性)"></a>降级开关的优先级(在同时打开的时候的有效性)</h3><p>强制降级 &gt; 自动降级 &gt; 失败降级</p>
<p>其中自动降级包含失败降级策略</p>
<h3 id="自动降级添加指定业务异常到失败统计并支持降级"><a href="#自动降级添加指定业务异常到失败统计并支持降级" class="headerlink" title="自动降级添加指定业务异常到失败统计并支持降级"></a>自动降级添加指定业务异常到失败统计并支持降级</h3><p>在一些业务场景中，调用端希望被调用端的一些常见业务异常，实际上是程序bug或底层逻辑或数据故障导致的异常，也可以被降级，例如空指针异常，数据库访问异常等等。<br>在这样的情况下，可以在调用端应用，如：app1应用，想要添加指定异常java.lang.NullPointerException和org.springframework.dao.DataAccessException<br>请在lion管理端添加key：app1.pigeon.invoker.degrade.customized.exception<br>内容为：java.lang.NullPointerException,org.springframework.dao.DataAccessException<br>多个异常之间用逗号隔开，以上配置可以动态修改</p>
<h3 id="业务自行降级"><a href="#业务自行降级" class="headerlink" title="业务自行降级"></a>业务自行降级</h3><p>前面提到的降级是pigeon内置的服务降级功能，通常pigeon提供的服务降级功能足够满足业务需求，但如果业务想自行进行服务降级，可以catch pigeon的RpcException，这个RpcException包括了超时等所有pigeon异常：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> xxxService.echo(<span class="string">"hello"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RpcException e) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"default value"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="降级相关异常统计、日志及监控输出"><a href="#降级相关异常统计、日志及监控输出" class="headerlink" title="降级相关异常统计、日志及监控输出"></a>降级相关异常统计、日志及监控输出</h3><p>如果使用pigeon内部的服务降级，服务降级返回默认对象的请求在CAT上PigeonCall不会统计作为失败，而是认为是成功，如果降级策略是抛出异常那么还是会统计作为失败请求。</p>
<p>每次降级的请求都会在CAT event里记录PigeonCall.degrade事件，如果每次降级想作为异常输出到CAT，可以配置pigeon.invoker.degrade.log.enable参数为true，这样每次降级后pigeon会在CAT problem输出com.dianping.pigeon.remoting.invoker.exception.ServiceDegradedException</p>
<p>如果业务有自己的服务降级策略，优先调远程pigeon服务，如果调用失败可以返回默认值，但又不希望pigeon把异常记录到CAT，可以在调用远程服务前按如下例子进行设置：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">InvokerHelper.setLogCallException(<span class="keyword">false</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> xxxService.echo(<span class="string">"hello"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RpcException e) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"default value"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="配置客户端调用模式"><a href="#配置客户端调用模式" class="headerlink" title="配置客户端调用模式"></a>配置客户端调用模式</h2><p>在pigeon内部，客户端调用远程服务有4种模式（sync/future/callback/oneway），例如spring编程方式下只需要配置callType属性：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"echoService"</span> <span class="attr">class</span>=<span class="string">"com.dianping.pigeon.remoting.invoker.config.spring.ReferenceBean"</span> <span class="attr">init-method</span>=<span class="string">"init"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"http://service.dianping.com/com.dianping.pigeon.demo.EchoService"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"interfaceName"</span> <span class="attr">value</span>=<span class="string">"com.dianping.pigeon.demo.EchoService"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"callType"</span> <span class="attr">value</span>=<span class="string">"sync"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeout"</span> <span class="attr">value</span>=<span class="string">"1000"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="sync"><a href="#sync" class="headerlink" title="sync"></a>sync</h3><p>同步调用，客户端线程会阻塞等待返回结果，默认设置是sync模式。</p>
<h3 id="oneway"><a href="#oneway" class="headerlink" title="oneway"></a>oneway</h3><p>客户端只是将请求传递给pigeon，pigeon提交给服务端，客户端也不等待立即返回，服务端也不会返回结果给客户端，这种方式一般都是没有返回结果的接口调用。​</p>
<h3 id="future"><a href="#future" class="headerlink" title="future"></a>future</h3><p>客户端将请求提交给pigeon后立即返回，不等待返回结果，由pigeon负责等待返回结果，客户端可以自行决定何时何地来取返回结果，代码示例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用ServiceA的method1</span></span><br><span class="line">serviceA.method1(<span class="string">"aaa"</span>);</span><br><span class="line"><span class="comment">//获取ServiceA的method1调用future状态</span></span><br><span class="line">Future future1OfServiceA = InvokerHelper.getFuture();</span><br><span class="line"><span class="comment">//调用ServiceA的method2</span></span><br><span class="line">serviceA.method2(<span class="string">"bbb"</span>);</span><br><span class="line"><span class="comment">//获取ServiceA的method2调用future状态</span></span><br><span class="line">Future future2OfServiceA = InvokerHelper.getFuture();</span><br><span class="line"><span class="comment">//调用ServiceB的method1</span></span><br><span class="line">serviceB.method1(<span class="string">"ccc"</span>);</span><br><span class="line"><span class="comment">//获取ServiceB的method1调用future状态</span></span><br><span class="line">Future future1OfServiceB = InvokerHelper.getFuture();</span><br><span class="line"><span class="comment">//获取ServiceA的method2调用结果</span></span><br><span class="line">Object result2OfServiceA = future2OfServiceA.get();</span><br><span class="line"><span class="comment">//获取ServiceA的method1调用结果</span></span><br><span class="line">Object result1OfServiceA = future1OfServiceA.get();</span><br><span class="line"><span class="comment">//获取ServiceB的method1调用结果</span></span><br><span class="line">Object result1OfServiceB = future1OfServiceB.get();</span><br></pre></td></tr></table></figure></p>
<p>最后的get()调用顺序由业务自行决定。操作总共花费的时间，大致等于耗时最长的服务方法执行时间。<br>除了get()接口，也可以使用get(timeout, TimeUnit.MILLISECONDS)指定超时时间。</p>
<h3 id="callback"><a href="#callback" class="headerlink" title="callback"></a>callback</h3><p>回调方式，客户端将请求提交给pigeon后立即返回，也不等待返回结果，它与future方式的区别是，callback必须提供一个实现了pigeon提供的InvocationCallback接口的回调对象给pigeon，pigeon负责接收返回结果并传递回给这个回调对象，代码示例：</p>
<blockquote>
<p>spring配置文件：</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"echoServiceWithCallback"</span> <span class="attr">class</span>=<span class="string">"com.dianping.pigeon.remoting.invoker.config.spring.ReferenceBean"</span> <span class="attr">init-method</span>=<span class="string">"init"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"http://service.dianping.com/com.dianping.pigeon.demo.EchoService"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"interfaceName"</span> <span class="attr">value</span>=<span class="string">"com.dianping.pigeon.demo.EchoService"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"callType"</span> <span class="attr">value</span>=<span class="string">"callback"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeout"</span> <span class="attr">value</span>=<span class="string">"1000"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"callback"</span> <span class="attr">ref</span>=<span class="string">"echoServiceCallback"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"echoServiceCallback"</span> <span class="attr">class</span>=<span class="string">"com.dianping.pigeon.demo.invoker.EchoServiceCallback"</span> /&gt;</span></span><br><span class="line">```		</span><br><span class="line">调用代码：</span><br><span class="line">```java</span><br><span class="line">import org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line">import com.dianping.pigeon.demo.EchoService;</span><br><span class="line"></span><br><span class="line">public class Invoker &#123;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) throws Exception &#123;</span><br><span class="line">		ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(new String[] &#123;“invoker.xml"&#125;);</span><br><span class="line">		context.start();</span><br><span class="line">		// 获取远程服务代理</span><br><span class="line">		EchoService echoServiceWithCallback = (EchoService)context.getBean(“echoServiceWithCallback");</span><br><span class="line">		String hello = echoServiceWithCallback.echo("world");</span><br><span class="line">		System.out.println( hello );</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Callback类：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.dianping.pigeon.remoting.invoker.concurrent.InvocationCallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoServiceCallback</span> <span class="keyword">implements</span> <span class="title">InvocationCallback</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger =  LoggerLoader.getLogger(EchoServiceCallback.class);</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Object result)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"callback:"</span> + result);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable exception)</span> </span>&#123;</span><br><span class="line">		logger.error(<span class="string">""</span>, exception);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果需要动态设置callback，比如在一个线程里发起多次服务调用请求，每次使用不同的callback，可以按照以下代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InvokerHelper.setCallback(<span class="keyword">new</span> InvocationCallback()&#123;...&#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="配置客户端集群策略模式"><a href="#配置客户端集群策略模式" class="headerlink" title="配置客户端集群策略模式"></a>配置客户端集群策略模式</h2><p>客户端配置cluster属性：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"echoService"</span> <span class="attr">class</span>=<span class="string">"com.dianping.pigeon.remoting.invoker.config.spring.ReferenceBean"</span> <span class="attr">init-method</span>=<span class="string">"init"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"http://service.dianping.com/com.dianping.pigeon.demo.EchoService"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"interfaceName"</span> <span class="attr">value</span>=<span class="string">"com.dianping.pigeon.demo.EchoService"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"callType"</span> <span class="attr">value</span>=<span class="string">"sync"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeout"</span> <span class="attr">value</span>=<span class="string">"1000"</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 失败策略，快速失败failfast/失败转移failover/失败忽略failsafe/并发取最快返回forking，默认failfast --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cluster"</span> <span class="attr">value</span>=<span class="string">"failfast"</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 是否超时重试，默认false --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeoutRetry"</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 重试次数，默认1 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"retries"</span> <span class="attr">value</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>failfast：调用服务的一个节点失败后抛出异常返回，可以同时配置重试timeoutRetry和retries属性</p>
</li>
<li><p>failover：调用服务的一个节点失败后会尝试调用另外的一个节点，可以同时配置重试timeoutRetry和retries属性</p>
</li>
<li><p>failsafe：调用服务的一个节点失败后不会抛出异常，返回null，后续版本会考虑按配置默认值返回</p>
</li>
<li><p>forking：同时调用服务的所有可用节点，返回调用最快的节点结果数据</p>
</li>
</ul>
<h3 id="客户端多连接"><a href="#客户端多连接" class="headerlink" title="客户端多连接"></a>客户端多连接</h3><p>pigeon 客户端默认使用的单连接，2.9.0及以后的版本支持多连接配置，多连接对性能有一定的提升，目前多连接配置是应用级别。</p>
<p>配置方式：增加pigeon.channel.pool.normal.size配置，默认值为1，最大可配置到5。一般如果有需要配置到2即可。</p>
<p>如果是lion配置，需要设置xxx-service.pigeon.channel.pool.normal.size配置</p>
<h3 id="异步编程"><a href="#异步编程" class="headerlink" title="异步编程"></a>异步编程</h3><p>如果要追求最好的单机性能，需要通过pigeon进行异步编程。</p>
<p>1、客户端调用方式选择future或callback方式。 可以参考前面的“配置客户端调用模式”说明</p>
<p>2、服务端一般业务场景都采用多线程实现并发，如果要实现异步编程，需要使用事件驱动callback模式。一般可以在IO调用的callback里回写服务调用结果，服务端需要加lion配置xxx.pigeon.provider.reply.manual为true（xxx为应用app name）</p>
<p>pigeon服务里如果有任何IO操作，需要该IO操作支持callback编程，IO操作常见的有缓存访问（支持callback调用）、数据库访问（正在开发callback调用支持）、pigeon服务调用（支持callback调用） </p>
<p>例如在一个pigeon服务里调用了cache操作，需要在cache框架也支持callback模式，然后在callback里调用pigeon的api去回写最终返回客户端的结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class XXXDefaultService implements XXXService &#123;</span><br><span class="line"> </span><br><span class="line">    public XXXDefaultService() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Autowired</span><br><span class="line">    private CacheService cacheService;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    public String get(CacheKey cacheKey) &#123;</span><br><span class="line">        cacheService.asyncGet(cacheKey, new CacheCallback&lt;String&gt;() &#123;</span><br><span class="line"> </span><br><span class="line">            private ProviderContext providerContext = ProviderHelper.getContext();</span><br><span class="line"> </span><br><span class="line">            @Override</span><br><span class="line">            public void onSuccess(String result) &#123;</span><br><span class="line">                ProviderHelper.writeSuccessResponse(providerContext, result);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            @Override</span><br><span class="line">            public void onFailure(String msg, Throwable e) &#123;</span><br><span class="line">                ProviderHelper.writeFailureResponse(providerContext, new RuntimeException(msg));</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125;);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    public Map&lt;CacheKey, String&gt; batchGet(List&lt;CacheKey&gt; cacheKeys) &#123;</span><br><span class="line">        cacheService.asyncBatchGet(cacheKeys, new CacheCallback&lt;Map&lt;CacheKey, String&gt;&gt;() &#123;</span><br><span class="line"> </span><br><span class="line">            private ProviderContext providerContext = ProviderHelper.getContext();</span><br><span class="line"> </span><br><span class="line">            @Override</span><br><span class="line">            public void onSuccess(Map&lt;CacheKey, String&gt; result) &#123;</span><br><span class="line">                ProviderHelper.writeSuccessResponse(providerContext, result);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            @Override</span><br><span class="line">            public void onFailure(String msg, Throwable e) &#123;</span><br><span class="line">                ProviderHelper.writeFailureResponse(providerContext, new RuntimeException(msg));</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125;);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、改进后的基于服务级别的异步化方式<br>不需要再去配置pigeon.provider.reply.manual，否则会影响整个应用，只需要在需要异步化的服务实现当中调用ProviderHelper.startAsync()获取ProviderContext后即可进行异步编程。参考代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class XXXDefaultService implements XXXService &#123;</span><br><span class="line"></span><br><span class="line">    public XXXDefaultService() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private CacheService cacheService;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String get(CacheKey cacheKey) &#123;</span><br><span class="line">        cacheService.asyncGet(cacheKey, new CacheCallback&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            private ProviderContext providerContext = ProviderHelper.startAsync();</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onSuccess(String result) &#123;</span><br><span class="line">                ProviderHelper.writeSuccessResponse(providerContext, result);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onFailure(String msg, Throwable e) &#123;</span><br><span class="line">                ProviderHelper.writeFailureResponse(providerContext, new RuntimeException(msg));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Map&lt;CacheKey, String&gt; batchGet(List&lt;CacheKey&gt; cacheKeys) &#123;</span><br><span class="line">        cacheService.asyncBatchGet(cacheKeys, new CacheCallback&lt;Map&lt;CacheKey, String&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            private ProviderContext providerContext = ProviderHelper.startAsync();</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onSuccess(Map&lt;CacheKey, String&gt; result) &#123;</span><br><span class="line">                ProviderHelper.writeSuccessResponse(providerContext, result);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onFailure(String msg, Throwable e) &#123;</span><br><span class="line">                ProviderHelper.writeFailureResponse(providerContext, new RuntimeException(msg));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ZooKeeper协议格式"><a href="#ZooKeeper协议格式" class="headerlink" title="ZooKeeper协议格式"></a>ZooKeeper协议格式</h3><p>1、服务地址配置：</p>
<p>每个服务都有一个全局唯一的url代表服务名称，比如我们有一个服务： <a href="http://service.dianping.com/com.dianping.pigeon.demo.EchoService" target="_blank" rel="noopener">http://service.dianping.com/com.dianping.pigeon.demo.EchoService</a> 服务名称url格式不固定，只要求是字符串在公司内部唯一即可。 Pigeon服务端每次启动后会将自身ip:port注册到ZooKeeper集群中。 在ZooKeeper中pigeon服务具体格式是这样的： pigeon服务都会写到/DP/SERVER节点下： /DP/SERVER/http:^^service.dianping.com^com.dianping.pigeon.demo.EchoService 的值为：192.168.93.1:4088,192.168.93.2:4088 多台服务器就是逗号分隔，客户端只需要拿到这个值就能知道这个服务的服务器地址列表。</p>
<p>2、服务权重配置：</p>
<p>pigeon服务还会写到/DP/WEIGHT/192.168.93.1:4088这个节点，值为1代表权重，如果为0代表这台机器暂时不提供服务，目前只有1和0两种值。</p>
<p>3、服务所属应用配置：</p>
<p>pigeon服务还会写到/DP/APP/192.168.93.1:4088这个节点，值为这个服务所属的应用名，这个应用名是读取本地classpath下META-INF/app.properties里的app.name值。</p>
<p>客户端需要拿到服务对应的地址列表、每个地址对应的权重weight，就可以自己实现负载均衡策略去调其中一台服务器。</p>
<h3 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h3><p>1、基于token的认证 pigeon支持基于token的认证方式，token认证在pigeon的http和tcp协议层面都同时支持，如果开启token认证，客户端请求中必须设置pigeon规范的token，否则请求将被拒绝</p>
<p>对于服务端：</p>
<p>a、打开token认证开关，token认证开关默认是关闭的，需要服务提供方自行打开，在lion里配置key，如xxx-service这个应用：</p>
<p>配置xxx-service.pigeon.provider.token.enable，内容为true</p>
<p>b、需要定义每个客户端的密钥，在配置中心lion里配置key：xxx-service.pigeon.provider.token.app.secrets，内容如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx-web:r3wzPd4azsHEhgDI69jubmV,yyy-service:45etwFsfFsHEdrg9ju3</span><br></pre></td></tr></table></figure></p>
<p>分别代表xxx-web和yyy-service的密钥，针对每个应用配置不同的密钥，密钥需要严格管理，不能泄露，目前限定密钥长度必须不少于16个字符</p>
<p>c、如果服务提供方希望客户端在http header里设置token，可以在lion里配置xxx-service.pigeon.console.token.header为true，否则默认可以是url里带上token</p>
<p>d、客户端需要带上timestamp到服务端，在服务端会对timestamp进行校验，默认只接受时差2分钟以内的请求，如果要调整可以设置： </p>
<p>xxx-service.pigeon.provider.token.timestamp.diff，默认为120（单位秒）</p>
<p>e、如果服务提供方只希望http客户端进行认证，而不希望默认的tcp客户端做认证（老业务），需要配置</p>
<p>xxx-service.pigeon.provider.token.protocol.default.enable为false</p>
<p>f、如果服务提供方希望部分服务或方法开启或不开启认证，需要配置</p>
<p>xxx-service.pigeon.provider.token.switches，内容类似com.dianping.pigeon.demo.EchoService=false,com.dianping.pigeon.demo.EchoService#echo2=true</p>
<p>这里边com.dianping.pigeon.demo.EchoService服务下所有方法是默认不开启认证，但echo2方法需要开启认证</p>
<p>对于客户端：</p>
<p>a、对于使用pigeon java客户端的应用，只需要配置所依赖的服务的密钥，在配置中心lion里配置key，如xxx-web这个应用：</p>
<p>配置xxx-web.pigeon.invoker.token.app.secrets，内容如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx-service:r3wzPd4azsHEhgDI69jubmV,yyy-service:45etwFsfFsHEdrg9ju3</span><br></pre></td></tr></table></figure></p>
<p>分别代表访问xxx-service和yyy-service的密钥，针对每个服务端配置不同的密钥，密钥需要严格管理，不能泄露，这个配置不要跟服务端配置共享，应严格独立管理</p>
<p>b、对于未使用pigeon java客户端的应用，如果通过HTTP GET方式请求，需要根据服务提供方提供的密钥，生成token，具体规则如下：<br>如果服务提供方允许url带token传递，可以按以下url格式来发出请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://pigeon.dper.com/xxx-service/invoke.json?app=xxx-web&amp;token=v5cg4EUS4c8wIjOC70VwvvgxZzg&amp;timestamp=1458447031&amp;url=http://service.dianping.com/com.dianping.pigeon.demo.EchoService&amp;method=echo&amp;parameterTypes=java.lang.String&amp;parameters=scott</span><br></pre></td></tr></table></figure></p>
<p>url里必须再带上timestamp，timestamp=1458447031 url里也必须带上app=xxx-web，以便在服务端进行认证</p>
<p>其中token生成规则是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String token = SecurityUtils.encrypt(data, secret)</span><br></pre></td></tr></table></figure></p>
<p>data字符串组成：服务名url + “#” + 服务方法名 + “#” + timestamp（目前为简单起见未加入请求参数等），例如调用<a href="http://service.dianping.com/com.dianping.pigeon.demo.EchoService这个服务的echo方法：" target="_blank" rel="noopener">http://service.dianping.com/com.dianping.pigeon.demo.EchoService这个服务的echo方法：</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://service.dianping.com/com.dianping.pigeon.demo.EchoService#echo#1458442458</span><br></pre></td></tr></table></figure></p>
<p>timestamp是System.currentTimeMillis()/1000，也就是到秒 </p>
<p>secret就是这个服务提供方给的密钥，例如上面的r3wzPd4azsHEhgDI69jubmV </p>
<p>c、如果服务提供方必须要求客户端将token等放在header里，以上url简化为： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://pigeon.dper.com/xxx-service/invoke.json?url=http://service.dianping.com/com.dianping.pigeon.demo.EchoService&amp;method=echo&amp;parameterTypes=java.lang.String&amp;parameters=scott</span><br></pre></td></tr></table></figure>
<p>在header里必须有两个key： </p>
<p>Timestamp,内容为上述类似的System.currentTimeMillis()/1000值，例如：1458447031 </p>
<p>Authorization，内容格式例如：</p>
<p>pigeon=xxx-web:v5cg4EUS4c8wIjOC70VwvvgxZzg </p>
<p>pigeon=为必须填的字符串，xxx-service代表客户端app名称，冒号:后边的字符串为token值</p>
<p>d、SecurityUtils.encrypt方法可以参考下面代码，内部采用HmacSHA1算法，通过密钥对某个字符串进行签名，然后转换为base64编码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">import javax.crypto.Mac;</span><br><span class="line">import javax.crypto.spec.SecretKeySpec;</span><br><span class="line">import org.apache.commons.codec.binary.Base64;</span><br><span class="line"> </span><br><span class="line">public class SecurityUtils &#123;</span><br><span class="line"> </span><br><span class="line">    private static final String HMAC_SHA1_ALGORITHM = &quot;HmacSHA1&quot;;</span><br><span class="line"> </span><br><span class="line">    public static String encrypt(String data, String secret) throws SecurityException &#123;</span><br><span class="line">        String result;</span><br><span class="line">        try &#123;</span><br><span class="line">            // get an hmac_sha1 key from the raw key bytes</span><br><span class="line">            SecretKeySpec signingKey = new SecretKeySpec(key.getBytes(), HMAC_SHA1_ALGORITHM);</span><br><span class="line"> </span><br><span class="line">            // get an hmac_sha1 Mac instance and initialize with the signing key</span><br><span class="line">            Mac mac = Mac.getInstance(HMAC_SHA1_ALGORITHM);</span><br><span class="line">            mac.init(signingKey);</span><br><span class="line"> </span><br><span class="line">            // compute the hmac on input data bytes</span><br><span class="line">            byte[] rawHmac = mac.doFinal(data.getBytes());</span><br><span class="line"> </span><br><span class="line">            // base64-encode the hmac</span><br><span class="line">            result = Base64.encodeBase64URLSafeString(rawHmac);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new SecurityException(&quot;Failed to generate HMAC : &quot; + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>e、如果是其他语言客户端，请参考以上逻辑自行加入认证token等信息</p>
<p>以上涉及lion的所有配置都是可以随时修改、动态生效</p>
<p>2、基于ip的认证 </p>
<p>a、默认是关闭的，需要打开，对于xxx-service这个应用来说，可以在lion配置</p>
<p>xxx-service.pigeon.provider.access.ip.enable为true </p>
<p>b、分为3个配置：</p>
<p>判断逻辑是先判断白名单(xxx-service.pigeon.provider.access.ip.whitelist配置，ip网段逗号分隔)是否匹配来源ip前缀，如果匹配，直接返回true允许访问 </p>
<p>如果不匹配，去黑名单（xxx-service.pigeon.provider.access.ip.blacklist配置，ip网段逗号分隔）找是否匹配来源ip前缀，黑名单里匹配到了，直接返回false不允许访问 </p>
<p>如果都没找到，返回xxx-service.pigeon.provider.access.ip.default值，默认是true，代表默认是允许访问</p>
<p>3、基于app的认证</p>
<p>a、默认是关闭的，需要打开，对于xxx-service这个应用来说，可以在lion配置</p>
<p>xxx-service.pigeon.provider.access.app.enable为true</p>
<p>b、分为3个配置：</p>
<p>判断逻辑是先判断白名单(xxx-service.pigeon.provider.access.app.whitelist配置，app之间用逗号分隔)是否匹配来源app，如果匹配，直接返回true允许访问</p>
<p>如果不匹配，去黑名单（xxx-service.pigeon.provider.access.app.blacklist配置，app之间用逗号分隔）找是否匹配来源app，黑名单里匹配到了，直接返回false不允许访问</p>
<p>如果都没找到，返回xxx-service.pigeon.provider.access.app.default值，默认是true，代表默认是允许访问</p>
<h3 id="自定义服务发布策略"><a href="#自定义服务发布策略" class="headerlink" title="自定义服务发布策略"></a>自定义服务发布策略</h3><p>如果在服务发布的过程中，想根据一些环境信息采用不同的服务发布策略，例如在北京发布服务时，屏蔽或过滤一些服务。</p>
<p>需要实现一个<code>com.dianping.pigeon.remoting.provider.publish.PublishPolicy</code>接口，采用jdk的ServiceLoader方式加载。下面将给出一个使用示例。</p>
<p>1、建议继承com.dianping.pigeon.remoting.provider.publish.AbstractPublishPolicy抽象类。例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">package com.dianping.pigeon.benchmark.customize;</span><br><span class="line"> </span><br><span class="line">import com.dianping.pigeon.config.ConfigManagerLoader;</span><br><span class="line">import com.dianping.pigeon.remoting.provider.config.ProviderConfig;</span><br><span class="line">import com.dianping.pigeon.remoting.provider.publish.AbstractPublishPolicy;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line"> </span><br><span class="line">/**</span><br><span class="line"> * Created by chenchongze on 16/11/3.</span><br><span class="line"> */</span><br><span class="line">public class MyPublishPolicy extends AbstractPublishPolicy &#123;</span><br><span class="line"> </span><br><span class="line">    private final Logger logger = LoggerFactory.getLogger(this.getClass());</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    public void doAddService(ProviderConfig providerConfig) &#123;</span><br><span class="line">        if (isBeijingHost(ConfigManagerLoader.getConfigManager().getLocalIp(), providerConfig.getUrl())) &#123;</span><br><span class="line">            logger.warn(&quot;do not publish service: &quot; + providerConfig);</span><br><span class="line">            return;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            super.doAddService(providerConfig);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    private boolean isBeijingHost(String localIp, String serviceName) &#123;</span><br><span class="line">        // 判断本地机器是不是北京的(例如可以用lion的region判断接口)，同时服务名包含“Test”字符串</span><br><span class="line">        return localIp.startsWith(&quot;172&quot;) &amp;&amp; serviceName.contains(&quot;Test&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2、在项目的resources资源文件<code>META-INF/services/</code>下，新建<code>com.dianping.pigeon.remoting.provider.publish.PublishPolicy</code>文件。</p>
<p>注意是<code>src/main/resources/META-INF/services/</code>文件夹，而不是webapps下的那个META-INF。</p>
<p>在<code>com.dianping.pigeon.remoting.provider.publish.PublishPolicy</code>文件中写入实现类，Demo中为：</p>
<p>com.dianping.pigeon.benchmark.customize.MyPublishPolicy</p>
<h2 id="Pigeon-常见问题"><a href="#Pigeon-常见问题" class="headerlink" title="Pigeon 常见问题"></a>Pigeon 常见问题</h2><h3 id="如何传递自定义参数"><a href="#如何传递自定义参数" class="headerlink" title="如何传递自定义参数"></a>如何传递自定义参数</h3><p>使用com.dianping.pigeon.remoting.common.util.ContextUtils类的接口</p>
<h4 id="简单的客户端A-gt-服务端B的一级调用链路的参数传递"><a href="#简单的客户端A-gt-服务端B的一级调用链路的参数传递" class="headerlink" title="简单的客户端A-&gt;服务端B的一级调用链路的参数传递"></a>简单的客户端A-&gt;服务端B的一级调用链路的参数传递</h4><p>客户端：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String url = <span class="string">"http://service.dianping.com/com.dianping.pigeon.demo.EchoService"</span>;</span><br><span class="line">EchoService service = ServiceFactory.getService(url, EchoService.class);</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">ContextUtils.putRequestContext(<span class="string">"key1"</span>, <span class="string">"value1"</span>);</span><br><span class="line">System.out.println(<span class="string">"service result:"</span> + service.echo(input));</span><br></pre></td></tr></table></figure></p>
<p>服务端：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">    System.out.println(ContextUtils.getLocalContext(<span class="string">"key1"</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"echo:"</span> + input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="服务端B-gt-客户端A的参数传回"><a href="#服务端B-gt-客户端A的参数传回" class="headerlink" title="服务端B-&gt;客户端A的参数传回"></a>服务端B-&gt;客户端A的参数传回</h4><p>服务端：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ContextUtils.putResponseContext(<span class="string">"key1"</span>, <span class="string">"value1"</span>);</span><br></pre></td></tr></table></figure></p>
<p>客户端：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ContextUtils.getResponseContext(&quot;key1&quot;);</span><br></pre></td></tr></table></figure></p>
<h4 id="全链路传递"><a href="#全链路传递" class="headerlink" title="全链路传递"></a>全链路传递</h4><p>如果需要在全链路传递对象，如A-&gt;B-&gt;C-&gt;D，需要使用以下接口：</p>
<p>在A发送请求端：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ContextUtils.putGlobalContext(<span class="string">"key1"</span>, <span class="string">"value1"</span>);</span><br></pre></td></tr></table></figure></p>
<p>在D接收请求端：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ContextUtils.getGlobalContext(<span class="string">"key1"</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="如何指定固定ip-port访问pigeon服务"><a href="#如何指定固定ip-port访问pigeon服务" class="headerlink" title="如何指定固定ip:port访问pigeon服务"></a>如何指定固定ip:port访问pigeon服务</h3><p>1、客户端可以配置只连某台服务器进行pigeon服务调试，比如qa环境可以在你的classpath下配置config/pigeon_qa.properties文件，实现只访问192.168.0.1:4040提供的pigeon服务：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://service.dianping.com/com.dianping.pigeon.demo.EchoService=192.168.0.1:4040</span><br></pre></td></tr></table></figure></p>
<p>这种方式要求应用增加一个lion配置：<br>xxx-service.pigeon.registry.config.local设置为true，在线下默认开启，线上关闭，不建议线上开启</p>
<p>2、通过api方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConfigManagerLoader.getConfigManager().setLocalStringValue(&quot;http://service.dianping.com/com.dianping.pigeon.demo.EchoService&quot;, &quot;192.168.0.1:4040&quot;);</span><br></pre></td></tr></table></figure></p>
<p>需要在程序启动时，调用前设置。这种方式要求应用增加一个lion配置：</p>
<p>xxx-service.pigeon.registry.config.local设置为true，在线下默认开启，线上关闭，不建议线上开启</p>
<p>3、运行时动态指定</p>
<p>如果要在代码层面设置，需要在调用服务前指定以下代码，线程级别每次请求前设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InvokerHelper.setAddress(&quot;192.168.0.1:4040&quot;);</span><br></pre></td></tr></table></figure></p>
<p>该方式请在非线上环境使用，一般用于测试。</p>
<h3 id="如何定义自己的拦截器"><a href="#如何定义自己的拦截器" class="headerlink" title="如何定义自己的拦截器"></a>如何定义自己的拦截器</h3><p>pigeon在客户端调用和服务端调用都提供了拦截器机制，方便用户可以获取到调用参数和返回结果。</p>
<p>注意：请不要在拦截器当中写消耗性能的代码，因为拦截器中的代码都是同步调用，如果执行太慢会影响服务调用的执行时间，用户如果想在拦截器中实现复杂逻辑，请自行进行异步处理。</p>
<p>在客户端可以实现自己的拦截器：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package com.dianping.pigeon.demo.interceptor;</span><br><span class="line">  </span><br><span class="line">import com.dianping.pigeon.remoting.invoker.domain.InvokerContext;</span><br><span class="line">import com.dianping.pigeon.remoting.invoker.process.InvokerInterceptor;</span><br><span class="line"> </span><br><span class="line">public class MyInvokerInterceptor implements InvokerInterceptor &#123;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    public void preInvoke(InvokerContext invokerContext) &#123;</span><br><span class="line">        System.out.println(&quot;preInvoke:&quot; + invokerContext.getRequest());    </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    public void postInvoke(InvokerContext invokerContext) &#123;</span><br><span class="line">        // TODO Auto-generated method stub</span><br><span class="line">         </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    public void afterThrowing(InvokerContext invokerContext, Throwable throwable) &#123;</span><br><span class="line">        // TODO Auto-generated method stub</span><br><span class="line">         </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在classpath下META-INF下增加一个services目录，目录下放一个com.dianping.pigeon.remoting.invoker.process.InvokerInterceptor文件，文件内容如下<br>在系统初始化时注册到pigeon中：</p>
<p>com.dianping.pigeon.demo.interceptor.MyInvokerInterceptor</p>
<p>同样的，在服务端也可以定义类似的拦截器：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package com.dianping.pigeon.demo.interceptor;</span><br><span class="line"> </span><br><span class="line">import com.dianping.pigeon.remoting.provider.domain.ProviderContext;</span><br><span class="line">import com.dianping.pigeon.remoting.provider.process.ProviderInterceptor;</span><br><span class="line"> </span><br><span class="line">public class MyProviderInterceptor implements ProviderInterceptor &#123;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    public void preInvoke(ProviderContext providerContext) &#123;</span><br><span class="line">        System.out.println(&quot;preInvoke:&quot; + providerContext);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    public void postInvoke(ProviderContext providerContext) &#123;</span><br><span class="line">        // TODO Auto-generated method stub</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在classpath下META-INF下增加一个services目录，目录下增加一个com.dianping.pigeon.remoting.provider.process.ProviderInterceptor文件，文件内容如下，它会在系统初始化时注册到pigeon中：</p>
<p>com.dianping.pigeon.demo.interceptor.MyProviderInterceptor</p>
<h3 id="如何关闭自动注册"><a href="#如何关闭自动注册" class="headerlink" title="如何关闭自动注册"></a>如何关闭自动注册</h3><p>强烈建议不要关闭自动注册，如果特殊场合比如某些服务端需要自己做预热处理后再注册服务，可能需要关闭自动注册功能：</p>
<p>1、在应用的classpath下放config/pigeon.properties文件（该文件的配置是所有环境都生效，包括关闭线上自动注册，请谨慎使用，如果是只设置某个环境，也可以是</p>
<p>pigeon_dev.properties/pigeon_alpha.properties/pigeon_qa.properties/pigeon_prelease.properties/pigeon_product.properties），内容如下:</p>
<p>pigeon.autoregister.enable=false</p>
<p>这个配置也可以放在绝对路径/data/webapps/config/pigeon/pigeon.properties文件里</p>
<p>如果是关闭整个应用所有机器的自动注册，可以在lion对应项目配置里加上以下配置，如shop-server这个应用：</p>
<p>shop-server.pigeon.autoregister.enable配置为false</p>
<p>2、预热完了之后，再调pigeon的api完成服务发布：</p>
<p>ServiceFactory.online();</p>
<p>建议在全部初始化完成之后再调这个方法，如果没有调用这个接口，需要自行通过管理端程序去修改注册中心状态</p>
<h3 id="服务端如何获取客户端信息"><a href="#服务端如何获取客户端信息" class="headerlink" title="服务端如何获取客户端信息"></a>服务端如何获取客户端信息</h3><p>使用com.dianping.pigeon.remoting.common.util.ContextUtils类的接口</p>
<p>可通过<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(String) ContextUtils.getLocalContext(<span class="string">"CLIENT_IP"</span>)</span><br></pre></td></tr></table></figure></p>
<p>拿到上一级调用客户端的ip地址<br>可通过<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(String) ContextUtils.getLocalContext(<span class="string">"CLIENT_APP"</span>)</span><br></pre></td></tr></table></figure></p>
<p>拿到上一级调用客户端的appname</p>
<p>可通过<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ContextUtils.getGlobalContext(<span class="string">"SOURCE_IP"</span>)</span><br></pre></td></tr></table></figure></p>
<p>拿到请求最前端发起者的ip地址</p>
<p>可通过<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ContextUtils.getGlobalContext(<span class="string">"SOURCE_APP"</span>)</span><br></pre></td></tr></table></figure></p>
<p>拿到请求最前端发起者的appname</p>
<h3 id="如何自定义loadbalance"><a href="#如何自定义loadbalance" class="headerlink" title="如何自定义loadbalance"></a>如何自定义loadbalance</h3><p>一般情况下使用pigeon提供的random/roundRobin/weightedAutoaware这几种策略就足够了，如果需要自己实现负载均衡策略，可以在客户端的配置里添加loadBalanceClass属性，这个class必须实现com.dianping.pigeon.remoting.invoker.route.balance.LoadBalance接口，一般可以继承pigeon提供的AbstractLoadBalance抽象类或pigeon目前已有的loadbalance类。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=<span class="string">"echoService"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"com.dianping.pigeon.remoting.invoker.config.spring.ReferenceBean"</span></span><br><span class="line">init-method=<span class="string">"init"</span>&gt;</span><br><span class="line">	&lt;property name=<span class="string">"url"</span></span><br><span class="line">	value=<span class="string">"http://service.dianping.com/com.dianping.pigeon.demo.EchoService"</span> /&gt;</span><br><span class="line">	&lt;property name=<span class="string">"interfaceName"</span> value=<span class="string">"com.dianping.pigeon.demo.EchoService"</span> /&gt;</span><br><span class="line">	&lt;property name=<span class="string">"callType"</span> value=<span class="string">"sync"</span> /&gt;</span><br><span class="line">	&lt;property name=<span class="string">"timeout"</span> value=<span class="string">"1000"</span> /&gt;</span><br><span class="line">	&lt;property name=<span class="string">"loadBalanceClass"</span></span><br><span class="line">	value=<span class="string">"com.dianping.pigeon.demo.loadbalance.MyLoadbalance"</span> /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>MyLoadbalance.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLoadbalance</span> <span class="keyword">extends</span> <span class="title">RoundRobinLoadBalance</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Client <span class="title">doSelect</span><span class="params">(List&lt;Client&gt; clients, InvocationRequest request, <span class="keyword">int</span>[] weights)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"http://service.dianping.com/com.dianping.pigeon.demo.EchoService"</span>.equals(request.getServiceName()) &amp;&amp; <span class="string">"echo"</span>.equals(request.getMethodName())) &#123;</span><br><span class="line">            <span class="keyword">if</span> (request.getParameters().length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                Object p0 = request.getParameters()[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (p0 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> clients.get(Math.abs(p0.hashCode() % clients.size()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.doSelect(clients, request, weights);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="日志及监控输出控制"><a href="#日志及监控输出控制" class="headerlink" title="日志及监控输出控制"></a>日志及监控输出控制</h3><h4 id="如何控制cat上客户端超时异常的次数"><a href="#如何控制cat上客户端超时异常的次数" class="headerlink" title="如何控制cat上客户端超时异常的次数"></a>如何控制cat上客户端超时异常的次数</h4><p>pigeon可以设置客户端发生超时异常时在cat上控制异常记录的次数，可以在lion对应项目配置里加上以下配置，如xxx这个应用（需要保证classes/META-INF/app.properties里的app.name=xxx，这里的xxx必须与lion项目名称保持一致）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx.pigeon.invoker.log.timeout.period.apps=shop-server:0,data-server:100</span><br></pre></td></tr></table></figure></p>
<p>配置内容里，可以配置多个目标服务app的日志打印间隔，以逗号分隔，目标app也必须是点评统一标准应用名，如果某个目标服务app未配置则这个app的超时异常都会记录</p>
<p>每个app后边的数字，默认为0代表每个超时异常都会记录，如果配置为10000则任何超时异常都不会记录到cat，如果为1代表记录一半，如果为100代表每100个超时异常记录一次，数字越大记录的异常越少</p>
<h4 id="如何控制异常输出到cat和控制台"><a href="#如何控制异常输出到cat和控制台" class="headerlink" title="如何控制异常输出到cat和控制台"></a>如何控制异常输出到cat和控制台</h4><p>pigeon可以设置客户端调用异常时是否输出到cat和控制台，可以在lion对应项目配置里加上以下配置，如xxx这个应用（需要保证classes/META-INF/app.properties里的app.name=xxx，这里的xxx必须与lion项目名称保持一致）：</p>
<p>xxx.pigeon.invoker.log.exception.ignored=java.lang.InterruptedException,com.xxx.xxx.XxxException</p>
<p>如果不使用lion，可以在pigeon.properties里设置</p>
<p>pigeon.invoker.log.exception.ignored=java.lang.InterruptedException,com.xxx.xxx.XxxException</p>
<p>以上设置代表出现这些异常时pigeon不会记录异常到cat和控制台日志，但会抛出异常</p>
<h4 id="pigeon框架日志"><a href="#pigeon框架日志" class="headerlink" title="pigeon框架日志"></a>pigeon框架日志</h4><p>pigeon默认会将ERROR日志写入SYSTEM_ERR，WARN日志会写入SYSTEM_OUT，另外，pigeon内部还会将INFO和WARN级别的日志写入/data/applogs/pigeon/pigeon.*.log，但这个日志不会写入ERROR级别日志</p>
<h4 id="记录服务端每个请求的详细信息"><a href="#记录服务端每个请求的详细信息" class="headerlink" title="记录服务端每个请求的详细信息"></a>记录服务端每个请求的详细信息</h4><p>pigeon可以设在服务端记录客户端发过来的每个请求的详细信息，需要在lion相应项目里配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx.pigeon.provider.accesslog.enable=true</span><br></pre></td></tr></table></figure></p>
<p>配置好了之后pigeon会将日志记录在本地以下位置：</p>
<p>/data/applogs/pigeon/pigeon-access.log</p>
<p>每个请求记录的日志内容为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">应用名称+ &quot;@&quot; + 来源ip+ &quot;@&quot; + 请求对象内容（包含请求参数值等）+ &quot;@&quot; + 时间区间消耗</span><br></pre></td></tr></table></figure></p>
<p>如果要记录每个参数值的内容，必须添加配置： pigeon.log.parameters设置为true</p>
<h4 id="记录服务端业务异常详细日志"><a href="#记录服务端业务异常详细日志" class="headerlink" title="记录服务端业务异常详细日志"></a>记录服务端业务异常详细日志</h4><p>pigeon在服务端默认不会记录业务方法抛出的异常详细信息，如果需要记录这类业务异常，需要增加以下配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pigeon.provider.logserviceexception为true</span><br></pre></td></tr></table></figure></p>
<p>xxx是应用的app.name，需要与lion项目名称保持一致</p>
<h3 id="获取服务注册信息"><a href="#获取服务注册信息" class="headerlink" title="获取服务注册信息"></a>获取服务注册信息</h3><p>使用pigeon客户端接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.dianping.pigeon.governor.service.RegistrationInfoService</span><br></pre></td></tr></table></figure></p>
<p>用法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RegistrationInfoService registrationInfoService = ServiceFactory.getService(RegistrationInfoService.class);</span><br><span class="line">String app = registrationInfoService.getAppOfService(<span class="string">"com.dianping.demo.service.XXXService"</span>);</span><br></pre></td></tr></table></figure></p>
<p>依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dianping<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pigeon-governor-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>接口说明：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dianping.pigeon.governor.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.dianping.pigeon.registry.exception.RegistryException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * pigeon注册信息服务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiangwu</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RegistrationInfoService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取服务的应用名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url 服务名称，标示一个服务的url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> group 泳道名称，没有填null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 应用名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RegistryException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getAppOfService</span><span class="params">(String url, String group)</span> <span class="keyword">throws</span> RegistryException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取服务的应用名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url 服务名称，标示一个服务的url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 应用名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RegistryException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getAppOfService</span><span class="params">(String url)</span> <span class="keyword">throws</span> RegistryException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取服务地址的权重</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address 服务地址，格式ip:port</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 权重</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RegistryException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getWeightOfAddress</span><span class="params">(String address)</span> <span class="keyword">throws</span> RegistryException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取服务地址的应用名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address 服务地址，格式ip:port</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 应用名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RegistryException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getAppOfAddress</span><span class="params">(String address)</span> <span class="keyword">throws</span> RegistryException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取服务的地址列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url 服务名称，标示一个服务的url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> group 泳道，没有填null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 逗号分隔的地址列表，地址格式ip:port</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RegistryException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;String&gt; <span class="title">getAddressListOfService</span><span class="params">(String url, String group)</span> <span class="keyword">throws</span> RegistryException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取服务的地址列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url 服务名称，标示一个服务的url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 逗号分隔的地址列表，地址格式ip:port</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RegistryException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;String&gt; <span class="title">getAddressListOfService</span><span class="params">(String url)</span> <span class="keyword">throws</span> RegistryException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="泳道"><a href="#泳道" class="headerlink" title="泳道"></a>泳道</h3><p>泳道是lion提供的支持，用于机器级别的隔离，泳道配置在机器的/data/webapps/appenv里，例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">deployenv=qa</span><br><span class="line">zkserver=qa.lion.dp:2181</span><br><span class="line">swimlane=tg</span><br></pre></td></tr></table></figure></p>
<p>swimlane代表tg这个泳道，对于pigeon来说，如果一个service的机器定义了swimlane为tg，那么这个机器只能是客户端同样为tg泳道的机器能够调用</p>
<p>对于客户端来说，假设配置了泳道为tg，那么这个客户端机器调用远程服务时，会优先选择服务端泳道配置同样为tg的机器，如果tg泳道的机器不可用或不存在，才会调用其他未配置泳道的机器</p>
<h3 id="动态服务分组路由"><a href="#动态服务分组路由" class="headerlink" title="动态服务分组路由"></a>动态服务分组路由</h3><p>除了支持机器级别的隔离(泳道),pigeon还支持更细粒度,灵活性更高的服务分组隔离。</p>
<p>分组的主要特性为:<br>粒度细化到单个机器的单个服务级别<br>group 可运行时动态调整<br>group 不传递，只存在于一个调用层次<br>group 可以 fallback<br>配置了swimlane的机器不支持动态group特性</p>
<p>group 在 pigeon 的管理端(应用配置页面)进行配置。初始 group 全部为空。</p>
<p>配置group时,输入机器ip、服务名、分组配置即可。即时生效。</p>
<p>可在ip:4080/group查看分组配置信息。</p>
<h3 id="QPS监控信息"><a href="#QPS监控信息" class="headerlink" title="QPS监控信息"></a>QPS监控信息</h3><p>1、可以通过ip:4080/stats.json查看QPS信息</p>
<p>appRequestsReceived下会显示requests-lastsecond代表服务收到的请求最近一秒的QPS</p>
<p>appRequestsSent下会显示requests-lastsecond代表发出的请求最近一秒的QPS</p>
<p>2、QPS信息输出到监控系统</p>
<p>如果使用了cat监控系统，可以在cat的event里可以查看：</p>
<p>客户端发送的QPS：pigeonCall.QPS</p>
<p>服务端接收的QPS：pigeonService.QPS</p>
<p>在cat上可以看到从0-59秒在每一分钟的QPS值</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/14/2018.01.14.17/" rel="next" title="Guava Cache分析">
                <i class="fa fa-chevron-left"></i> Guava Cache分析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/03/31/directbuffer/" rel="prev" title="深入理解DirectBuffer">
                深入理解DirectBuffer <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
	  <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="马超" />
          <p class="site-author-name" itemprop="name">马超</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Pigeon开发指南"><span class="nav-number">1.</span> <span class="nav-text">Pigeon开发指南</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#主要特色"><span class="nav-number">1.1.</span> <span class="nav-text">主要特色</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#依赖"><span class="nav-number">1.2.</span> <span class="nav-text">依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备工作"><span class="nav-number">1.3.</span> <span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#通过maven构建项目"><span class="nav-number">1.3.1.</span> <span class="nav-text">通过maven构建项目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备环境"><span class="nav-number">1.3.2.</span> <span class="nav-text">准备环境</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ZooKeeper安装"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">ZooKeeper安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置ZooKeeper集群地址"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">配置ZooKeeper集群地址</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置服务摘除脚本"><span class="nav-number">1.3.3.</span> <span class="nav-text">配置服务摘除脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置应用名称"><span class="nav-number">1.3.4.</span> <span class="nav-text">配置应用名称</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置管理"><span class="nav-number">1.4.</span> <span class="nav-text">配置管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#本地配置"><span class="nav-number">1.4.1.</span> <span class="nav-text">本地配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lion配置"><span class="nav-number">1.4.2.</span> <span class="nav-text">lion配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#扩展pigeon-config模块"><span class="nav-number">1.4.3.</span> <span class="nav-text">扩展pigeon-config模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#快速入门"><span class="nav-number">1.5.</span> <span class="nav-text">快速入门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#定义服务"><span class="nav-number">1.5.1.</span> <span class="nav-text">定义服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务提供者"><span class="nav-number">1.5.2.</span> <span class="nav-text">服务提供者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务调用者"><span class="nav-number">1.5.3.</span> <span class="nav-text">服务调用者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务调用者-1"><span class="nav-number">1.5.4.</span> <span class="nav-text">服务调用者</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Schema配置方式"><span class="nav-number">1.6.</span> <span class="nav-text">Spring Schema配置方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务端Spring配置"><span class="nav-number">1.6.1.</span> <span class="nav-text">服务端Spring配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端Spring配置"><span class="nav-number">1.6.2.</span> <span class="nav-text">客户端Spring配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#API编程方式"><span class="nav-number">1.7.</span> <span class="nav-text">API编程方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务提供者-1"><span class="nav-number">1.7.1.</span> <span class="nav-text">服务提供者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务调用者-2"><span class="nav-number">1.7.2.</span> <span class="nav-text">服务调用者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ServiceFactory接口"><span class="nav-number">1.7.3.</span> <span class="nav-text">ServiceFactory接口</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#序列化支持"><span class="nav-number">1.8.</span> <span class="nav-text">序列化支持</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#protobuf3序列化支持"><span class="nav-number">1.8.1.</span> <span class="nav-text">protobuf3序列化支持</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP协议支持"><span class="nav-number">1.9.</span> <span class="nav-text">HTTP协议支持</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#POST方式"><span class="nav-number">1.9.1.</span> <span class="nav-text">POST方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GET方式"><span class="nav-number">1.9.2.</span> <span class="nav-text">GET方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务测试工具"><span class="nav-number">1.10.</span> <span class="nav-text">服务测试工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置负载均衡策略"><span class="nav-number">1.11.</span> <span class="nav-text">配置负载均衡策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置客户端的loadBalance属性"><span class="nav-number">1.11.1.</span> <span class="nav-text">配置客户端的loadBalance属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#运行中动态配置客户端的loadBalance属性"><span class="nav-number">1.11.2.</span> <span class="nav-text">运行中动态配置客户端的loadBalance属性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#客户端配置某个方法的超时时间"><span class="nav-number">1.12.</span> <span class="nav-text">客户端配置某个方法的超时时间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务隔离与限流"><span class="nav-number">1.13.</span> <span class="nav-text">服务隔离与限流</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置服务方法级别的最大并发数"><span class="nav-number">1.13.1.</span> <span class="nav-text">配置服务方法级别的最大并发数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#限制某个客户端应用的最大并发数"><span class="nav-number">1.13.2.</span> <span class="nav-text">限制某个客户端应用的最大并发数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务降级"><span class="nav-number">1.14.</span> <span class="nav-text">服务降级</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置接口的降级策略"><span class="nav-number">1.14.1.</span> <span class="nav-text">配置接口的降级策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置可降级的方法"><span class="nav-number">1.14.2.</span> <span class="nav-text">配置可降级的方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#强制降级开关"><span class="nav-number">1.14.3.</span> <span class="nav-text">强制降级开关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#失败降级开关"><span class="nav-number">1.14.4.</span> <span class="nav-text">失败降级开关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自动降级开关"><span class="nav-number">1.14.5.</span> <span class="nav-text">自动降级开关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#降级开关的优先级-在同时打开的时候的有效性"><span class="nav-number">1.14.6.</span> <span class="nav-text">降级开关的优先级(在同时打开的时候的有效性)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自动降级添加指定业务异常到失败统计并支持降级"><span class="nav-number">1.14.7.</span> <span class="nav-text">自动降级添加指定业务异常到失败统计并支持降级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#业务自行降级"><span class="nav-number">1.14.8.</span> <span class="nav-text">业务自行降级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#降级相关异常统计、日志及监控输出"><span class="nav-number">1.14.9.</span> <span class="nav-text">降级相关异常统计、日志及监控输出</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置客户端调用模式"><span class="nav-number">1.15.</span> <span class="nav-text">配置客户端调用模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sync"><span class="nav-number">1.15.1.</span> <span class="nav-text">sync</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#oneway"><span class="nav-number">1.15.2.</span> <span class="nav-text">oneway</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#future"><span class="nav-number">1.15.3.</span> <span class="nav-text">future</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#callback"><span class="nav-number">1.15.4.</span> <span class="nav-text">callback</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置客户端集群策略模式"><span class="nav-number">1.16.</span> <span class="nav-text">配置客户端集群策略模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端多连接"><span class="nav-number">1.16.1.</span> <span class="nav-text">客户端多连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异步编程"><span class="nav-number">1.16.2.</span> <span class="nav-text">异步编程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZooKeeper协议格式"><span class="nav-number">1.16.3.</span> <span class="nav-text">ZooKeeper协议格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安全性"><span class="nav-number">1.16.4.</span> <span class="nav-text">安全性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义服务发布策略"><span class="nav-number">1.16.5.</span> <span class="nav-text">自定义服务发布策略</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pigeon-常见问题"><span class="nav-number">1.17.</span> <span class="nav-text">Pigeon 常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#如何传递自定义参数"><span class="nav-number">1.17.1.</span> <span class="nav-text">如何传递自定义参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#简单的客户端A-gt-服务端B的一级调用链路的参数传递"><span class="nav-number">1.17.1.1.</span> <span class="nav-text">简单的客户端A-&gt;服务端B的一级调用链路的参数传递</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务端B-gt-客户端A的参数传回"><span class="nav-number">1.17.1.2.</span> <span class="nav-text">服务端B-&gt;客户端A的参数传回</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#全链路传递"><span class="nav-number">1.17.1.3.</span> <span class="nav-text">全链路传递</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何指定固定ip-port访问pigeon服务"><span class="nav-number">1.17.2.</span> <span class="nav-text">如何指定固定ip:port访问pigeon服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何定义自己的拦截器"><span class="nav-number">1.17.3.</span> <span class="nav-text">如何定义自己的拦截器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何关闭自动注册"><span class="nav-number">1.17.4.</span> <span class="nav-text">如何关闭自动注册</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务端如何获取客户端信息"><span class="nav-number">1.17.5.</span> <span class="nav-text">服务端如何获取客户端信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何自定义loadbalance"><span class="nav-number">1.17.6.</span> <span class="nav-text">如何自定义loadbalance</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日志及监控输出控制"><span class="nav-number">1.17.7.</span> <span class="nav-text">日志及监控输出控制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#如何控制cat上客户端超时异常的次数"><span class="nav-number">1.17.7.1.</span> <span class="nav-text">如何控制cat上客户端超时异常的次数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#如何控制异常输出到cat和控制台"><span class="nav-number">1.17.7.2.</span> <span class="nav-text">如何控制异常输出到cat和控制台</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pigeon框架日志"><span class="nav-number">1.17.7.3.</span> <span class="nav-text">pigeon框架日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#记录服务端每个请求的详细信息"><span class="nav-number">1.17.7.4.</span> <span class="nav-text">记录服务端每个请求的详细信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#记录服务端业务异常详细日志"><span class="nav-number">1.17.7.5.</span> <span class="nav-text">记录服务端业务异常详细日志</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取服务注册信息"><span class="nav-number">1.17.8.</span> <span class="nav-text">获取服务注册信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#泳道"><span class="nav-number">1.17.9.</span> <span class="nav-text">泳道</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态服务分组路由"><span class="nav-number">1.17.10.</span> <span class="nav-text">动态服务分组路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#QPS监控信息"><span class="nav-number">1.17.11.</span> <span class="nav-text">QPS监控信息</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">马超</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

<div>
<span id="busuanzi_container_site_pv">
    【本站总PV量<span id="busuanzi_value_site_pv"></span>次】
</span>

<span id="busuanzi_container_site_uv">
  【本站总UV量<span id="busuanzi_value_site_uv"></span>次】
</span>
</div>

        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://yoursite.com/2018/01/20/pigeon/';
          this.page.identifier = '2018/01/20/pigeon/';
          this.page.title = 'pigeon';
        };
        var d = document, s = d.createElement('script');
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  








  





  

  

  

  

  

</body>
</html>
